<% content_for :title, "Edit Bonus Template" %>

<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
          <i class="fas fa-edit"></i> Edit Bonus Template
        </h1>
        <%= link_to settings_templates_path, class: "btn btn-outline-secondary" do %>
          <i class="fas fa-arrow-left"></i> Back to Templates
        <% end %>
      </div>

      <div class="card">
        <div class="card-body">
          <%= form_with model: @bonus_template, url: settings_template_path(@bonus_template), method: :patch, local: true, 
              data: { 
                controller: "currency", 
                action: "submit->currency#validateForm" 
              } do |form| %>
            <% if @bonus_template.errors.any? %>
              <div class="alert alert-danger">
                <h5><%= pluralize(@bonus_template.errors.count, "error") %> prohibited this template from being saved:</h5>
                <ul>
                  <% @bonus_template.errors.full_messages.each do |message| %>
                    <li><%= message %></li>
                  <% end %>
                </ul>
              </div>
            <% end %>

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <%= form.label :name, class: "form-label" %>
                  <%= form.text_field :name, class: "form-control", placeholder: "Template name" %>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <%= form.label :dsl_tag, class: "form-label" %>
                  <%= form.text_field :dsl_tag, class: "form-control", placeholder: "DSL tag" %>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <%= form.label :project, class: "form-label" %>
                  <%= form.select :project, Project.order(:name).pluck(:name), { prompt: "Select project" }, { class: "form-select" } %>
                  <small class="form-text text-muted">Select "All" to create a template that applies to all projects</small>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <%= form.label :event, class: "form-label" %>
                  <%= form.select :event, BonusTemplate::EVENT_TYPES.map { |e| [e.humanize, e] }, { prompt: "Select event" }, { class: "form-select" } %>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <%= form.label :currencies, "Currencies", class: "form-label" %>
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted">Select currencies for the template</small>
                    <button type="button" class="btn btn-sm btn-outline-secondary" 
                            data-action="click->currency#uncheckAll">
                      <i class="bi bi-check2-all"></i> Uncheck all
                    </button>
                  </div>
                  <div class="currencies-checkboxes border rounded p-3" style="max-height: 150px; overflow-y: auto;">
                    <% selected_currencies = @bonus_template.currencies.present? ? @bonus_template.currencies : Bonus.all_currencies %>
                    <% Bonus.all_currencies.each_with_index do |currency, index| %>
                      <div class="form-check <%= 'mb-1' unless index == Bonus.all_currencies.length - 1 %>">
                        <%= check_box_tag "bonus_template[currencies][]", currency, 
                            selected_currencies.include?(currency),
                            {
                              class: "form-check-input currency-checkbox",
                              id: "currency_#{currency}",
                              data: { 
                                currency: currency,
                                "currency-target": "checkbox"
                              }
                            } %>
                        <%= label_tag "currency_#{currency}", currency, class: "form-check-label" %>
                      </div>
                    <% end %>
                  </div>
                </div>
              </div>
            </div>

            <!-- Currency Minimum Deposits -->
            <%= render "currency_minimum_deposits", form: form, bonus_template: @bonus_template %>

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <%= form.label :wager, class: "form-label" %>
                  <%= form.number_field :wager, class: "form-control", step: "0.01", placeholder: "0.00" %>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <%= form.label :maximum_winnings, class: "form-label" %>
                  <%= form.number_field :maximum_winnings, class: "form-control", step: "0.01", placeholder: "0.00" %>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <%= form.label :no_more, class: "form-label" %>
                  <%= form.number_field :no_more, class: "form-control", placeholder: "Unlimited" %>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <%= form.label :totally_no_more, class: "form-label" %>
                  <%= form.number_field :totally_no_more, class: "form-control", placeholder: "Unlimited" %>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <%= form.label :groups, class: "form-label" %>
                  <%= form.text_field :groups, class: "form-control", placeholder: "VIP, Premium (comma separated)" %>
                </div>
              </div>
            </div>

            <div class="mb-3">
              <%= form.label :description, class: "form-label" %>
              <%= form.text_area :description, class: "form-control", rows: 3, placeholder: "Template description" %>
            </div>

            <div class="d-flex justify-content-end gap-2">
              <%= link_to "Cancel", settings_templates_path, class: "btn btn-outline-secondary" %>
              <%= form.submit "Update Template", class: "btn btn-primary" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

