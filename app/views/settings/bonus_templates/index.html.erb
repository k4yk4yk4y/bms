<% content_for :title, "Bonus Templates" %>

<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">
          <i class="fas fa-layer-group"></i> Bonus Templates
        </h1>
        <%= link_to new_settings_template_path, class: "btn btn-primary" do %>
          <i class="fas fa-plus"></i> New Template
        <% end %>
      </div>

      <!-- Filters -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="row">
            <div class="col-md-3">
              <label for="project-filter" class="form-label">Project</label>
              <select id="project-filter" class="form-select">
                <option value="">All Projects</option>
                <% @projects.each do |project| %>
                  <option value="<%= project %>"><%= project %></option>
                <% end %>
              </select>
            </div>
            <div class="col-md-3">
              <label for="dsl-tag-filter" class="form-label">DSL Tag</label>
              <select id="dsl-tag-filter" class="form-select">
                <option value="">All DSL Tags</option>
                <% @dsl_tags.each do |dsl_tag| %>
                  <option value="<%= dsl_tag %>"><%= dsl_tag %></option>
                <% end %>
              </select>
            </div>
            <div class="col-md-3">
              <label for="event-filter" class="form-label">Event</label>
              <select id="event-filter" class="form-select">
                <option value="">All Events</option>
                <% BonusTemplate::EVENT_TYPES.each do |event| %>
                  <option value="<%= event %>"><%= event.humanize %></option>
                <% end %>
              </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <button id="clear-filters" class="btn btn-outline-secondary">
                <i class="fas fa-times"></i> Clear Filters
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Templates Table -->
      <div class="card">
        <div class="card-body">
          <% if @bonus_templates.any? %>
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>DSL Tag</th>
                    <th>Project</th>
                    <th>Event</th>
                    <th>Currency</th>
                    <th>Min Deposit</th>
                    <th>Wager</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% @bonus_templates.each do |template| %>
                    <tr data-project="<%= template.project %>" data-dsl-tag="<%= template.dsl_tag %>" data-event="<%= template.event %>">
                      <td>
                        <strong><%= template.name %></strong>
                        <% if template.description.present? %>
                          <br><small class="text-muted"><%= truncate(template.description, length: 50) %></small>
                        <% end %>
                      </td>
                      <td><span class="badge bg-info"><%= template.dsl_tag %></span></td>
                      <td>
                        <% if template.project == 'All' %>
                          <span class="badge bg-success" title="Applies to all projects">All Projects</span>
                        <% else %>
                          <span class="badge bg-secondary"><%= template.project %></span>
                        <% end %>
                      </td>
                      <td><span class="badge bg-primary"><%= template.event.humanize %></span></td>
                      <td><%= template.formatted_currencies || "All currencies" %></td>
                      <td><%= template.minimum_deposit || "N/A" %></td>
                      <td><%= template.wager || "N/A" %></td>
                      <td>
                        <div class="btn-group" role="group">
                          <%= link_to settings_template_path(template), class: "btn btn-sm btn-outline-primary", title: "View" do %>
                            <i class="fas fa-eye"></i>
                          <% end %>
                          <%= link_to edit_settings_template_path(template), class: "btn btn-sm btn-outline-warning", title: "Edit" do %>
                            <i class="fas fa-edit"></i>
                          <% end %>
                          <%= button_to settings_template_path(template), 
                              method: :delete, 
                              data: { confirm: "Are you sure you want to delete this template?" },
                              class: "btn btn-sm btn-outline-danger", 
                              title: "Delete",
                              form: { style: "display: inline;" } do %>
                            <i class="fas fa-trash"></i>
                          <% end %>
                        </div>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          <% else %>
            <div class="text-center py-5">
              <i class="fas fa-layer-group fa-3x text-muted mb-3"></i>
              <h4 class="text-muted">No templates found</h4>
              <p class="text-muted">Create your first bonus template to get started.</p>
              <%= link_to new_settings_template_path, class: "btn btn-primary" do %>
                <i class="fas fa-plus"></i> Create Template
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const projectFilter = document.getElementById('project-filter');
  const dslTagFilter = document.getElementById('dsl-tag-filter');
  const eventFilter = document.getElementById('event-filter');
  const clearFiltersBtn = document.getElementById('clear-filters');
  const tableRows = document.querySelectorAll('tbody tr');

  function filterTable() {
    const selectedProject = projectFilter.value;
    const selectedDslTag = dslTagFilter.value;
    const selectedEvent = eventFilter.value;

    tableRows.forEach(row => {
      const project = row.dataset.project;
      const dslTag = row.dataset.dslTag;
      const event = row.dataset.event;

      const projectMatch = !selectedProject || project === selectedProject;
      const dslTagMatch = !selectedDslTag || dslTag === selectedDslTag;
      const eventMatch = !selectedEvent || event === selectedEvent;

      if (projectMatch && dslTagMatch && eventMatch) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  }

  projectFilter.addEventListener('change', filterTable);
  dslTagFilter.addEventListener('change', filterTable);
  eventFilter.addEventListener('change', filterTable);

  clearFiltersBtn.addEventListener('click', function() {
    projectFilter.value = '';
    dslTagFilter.value = '';
    eventFilter.value = '';
    filterTable();
  });
});
</script>
