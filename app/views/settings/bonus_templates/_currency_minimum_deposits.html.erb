<!-- Currency Minimum Deposits Section -->
<div class="card mb-4" id="currency-minimum-deposits-card">
  <div class="card-header">
    <h5 class="card-title mb-0">
      <i class="bi bi-currency-exchange"></i> 
      Minimum deposits by currency
    </h5>
  </div>
  <div class="card-body">
    <div id="currency-minimum-deposits-container">
      <div class="row">
        <% all_currencies = Bonus.all_currencies %>
        <% selected_currencies = bonus_template.currencies.present? ? bonus_template.currencies : all_currencies %>
        
        <% selected_currencies.each_with_index do |currency, index| %>
          <div class="col-12 mb-2">
            <div class="input-group">
              <span class="input-group-text"><%= currency %></span>
              <%= number_field_tag "bonus_template[currency_minimum_deposits][#{currency}]", 
                  bonus_template.currency_minimum_deposits[currency],
                  class: "form-control currency-input",
                  step: Bonus.currency_step(currency),
                  min: 0,
                  placeholder: (Bonus.crypto_currency?(currency) ? "0.00000000" : "0.00"),
                  data: { 
                    currency: currency, 
                    precision: Bonus.currency_precision(currency),
                    "currency-target": "minimumDeposit"
                  } %>
            </div>
          </div>
        <% end %>
      </div>

    </div>
    
    <!-- Dynamic update based on selected currencies -->
    <script>
      // Helper function to get selected currencies from checkboxes
      function getSelectedCurrenciesMinimumDeposits() {
        const checkboxes = document.querySelectorAll('input.currency-checkbox:checked');
        return Array.from(checkboxes).map(checkbox => checkbox.value);
      }

      // Function to update currency minimum deposits fields based on selected currencies
      function updateCurrencyMinimumDepositsFields() {
        const container = document.getElementById('currency-minimum-deposits-container');
        if (!container) return;
        
        const selectedCurrencies = getSelectedCurrenciesMinimumDeposits();
        const allCurrencies = <%= Bonus.all_currencies.to_json.html_safe %>;
        const cryptoCurrencies = <%= Bonus.crypto_currencies.to_json.html_safe %>;
        
        // If no currencies selected, show all currencies but with empty values
        const displayCurrencies = selectedCurrencies.length > 0 ? selectedCurrencies : allCurrencies;
        
        // Rebuild the fields
        const rowDiv = container.querySelector('.row');
        if (!rowDiv) return;
        
        // Save current values for all currencies
        const currentValues = {};
        rowDiv.querySelectorAll('input[type="number"]').forEach(input => {
          const match = input.name.match(/currency_minimum_deposits\[([^\]]+)\]/);
          if (match && input.value) {
            currentValues[match[1]] = input.value;
          }
        });
        
        // Clear and rebuild
        rowDiv.innerHTML = '';
        
        displayCurrencies.forEach(currency => {
          const colDiv = document.createElement('div');
          colDiv.className = 'col-12 mb-2';
          
          const isCrypto = cryptoCurrencies.includes(currency);
          const step = isCrypto ? '0.00000001' : '0.01';
          const placeholder = isCrypto ? '0.00000000' : '0.00';
          const precision = isCrypto ? 8 : 2;
          
          // Use current value if it exists and currency is still selected
          const currentValue = selectedCurrencies.includes(currency) ? (currentValues[currency] || '') : '';
          
          colDiv.innerHTML = `
            <div class="input-group">
              <span class="input-group-text">${currency}</span>
              <input type="number" 
                     name="bonus_template[currency_minimum_deposits][${currency}]" 
                     value="${currentValue}"
                     class="form-control currency-input" 
                     step="${step}" 
                     min="0"
                     placeholder="${placeholder}"
                     data-currency="${currency}"
                     data-precision="${precision}"
                     data-currency-target="minimumDeposit">
            </div>
          `;
          
          rowDiv.appendChild(colDiv);
        });

      }
      
      // Note: Event listeners for currency checkboxes are handled by Stimulus currency controller
    </script>
  </div>
</div>
