<div class="card mb-4">
  <div class="card-header">
    <h5 class="card-title mb-0">
      <%= bonus.event&.humanize || 'Event Type' %> Configuration
    </h5>
  </div>
  <div class="card-body">
    <!-- Unified Reward Configuration -->
    <div class="card">
      <div class="card-header">
        <h6 class="card-title mb-0">
          <i class="bi bi-gift"></i> Reward Configuration
        </h6>
      </div>
      <div class="card-body">
        <!-- Add Bonus Rewards Menu -->
        <div class="mb-4">
          <h6 class="mb-3">Add Bonus Rewards</h6>
          <p class="text-muted mb-3">Choose the type of reward you want to add to this bonus.</p>
          
          <div class="d-flex flex-wrap gap-2">
            <button type="button" class="btn btn-success me-2" onclick="addBonusReward()">
              <i class="bi bi-plus-circle"></i> Add Cash Bonus
            </button>
            <button type="button" class="btn btn-primary me-2" onclick="addFreespinReward()">
              <i class="bi bi-gift"></i> Add Freespins
            </button>
            <button type="button" class="btn btn-info me-2" onclick="addBonusBuyReward()">
              <i class="bi bi-bag"></i> Add Bonus Buy
            </button>
            <button type="button" class="btn btn-warning me-2" onclick="addCompPointReward()">
              <i class="bi bi-star"></i> Add Comp Points
            </button>
            <button type="button" class="btn btn-secondary" onclick="addBonusCodeReward()">
              <i class="bi bi-key"></i> Add Bonus Code
            </button>
          </div>
        </div>

        <!-- Container for all rewards -->
        <div id="all-rewards-container">
          <!-- Existing rewards will be loaded here -->
          <% if bonus.persisted? %>
            <!-- Load existing bonus rewards -->
            <% if bonus.bonus_rewards.any? %>
              <div id="bonus-rewards-section">
                <% bonus.bonus_rewards.each_with_index do |reward, index| %>
                  <%= render "bonus_reward_form", form: form, bonus: bonus, reward: reward, index: index %>
                <% end %>
              </div>
            <% end %>
            
            <!-- Load existing freespin rewards -->
            <% if bonus.freespin_rewards.any? %>
              <div id="freespin-rewards-section">
                <% bonus.freespin_rewards.each_with_index do |reward, index| %>
                  <%= render "freespin_reward_form", form: form, bonus: bonus, reward: reward, index: index %>
                <% end %>
              </div>
            <% end %>

            <!-- Load existing bonus buy rewards -->
            <% if bonus.bonus_buy_rewards.any? %>
              <div id="bonus-buy-rewards-section">
                <% bonus.bonus_buy_rewards.each_with_index do |reward, index| %>
                  <%= render "bonus_buy_reward_form", form: form, bonus: bonus, reward: reward, index: index %>
                <% end %>
              </div>
            <% end %>

            <!-- Load existing comp point rewards -->
            <% if bonus.comp_point_rewards.any? %>
              <div id="comp-point-rewards-section">
                <% bonus.comp_point_rewards.each_with_index do |reward, index| %>
                  <%= render "comp_point_reward_form", form: form, bonus: bonus, reward: reward, index: index %>
                <% end %>
              </div>
            <% end %>

            <!-- Load existing bonus code rewards -->
            <% if bonus.bonus_code_rewards.any? %>
              <div id="bonus-code-rewards-section">
                <% bonus.bonus_code_rewards.each_with_index do |reward, index| %>
                  <%= render "bonus_code_reward_form", form: form, bonus: bonus, reward: reward, index: index %>
                <% end %>
              </div>
            <% end %>
          <% end %>

          <!-- Hidden sections for dynamic content -->
          <div id="bonus-rewards-section" style="<%= 'display: none;' unless bonus.persisted? && bonus.bonus_rewards.any? %>"></div>
          <div id="freespin-rewards-section" style="<%= 'display: none;' unless bonus.persisted? && bonus.freespin_rewards.any? %>"></div>
          <div id="bonus-buy-rewards-section" style="<%= 'display: none;' unless bonus.persisted? && bonus.bonus_buy_rewards.any? %>"></div>
          <div id="comp-point-rewards-section" style="<%= 'display: none;' unless bonus.persisted? && bonus.comp_point_rewards.any? %>"></div>
          <div id="bonus-code-rewards-section" style="<%= 'display: none;' unless bonus.persisted? && bonus.bonus_code_rewards.any? %>"></div>
        </div>

        <!-- No rewards message -->
        <div id="no-rewards-message" class="text-center py-5" style="<%= 'display: none;' if bonus.persisted? && (bonus.bonus_rewards.any? || bonus.freespin_rewards.any? || bonus.bonus_buy_rewards.any? || bonus.comp_point_rewards.any? || bonus.bonus_code_rewards.any?) %>">
          <i class="bi bi-info-circle text-muted fs-1"></i>
          <h6 class="text-muted mt-2">No rewards configured yet</h6>
          <p class="text-muted">Click one of the buttons above to add your first reward.</p>
        </div>
      </div>
    </div>
    
    <% if bonus.persisted? && bonus.has_rewards? %>
      <div class="mt-3">
        <h6>Current Rewards:</h6>
        <ul class="list-unstyled">
          <% bonus.reward_types.each do |type| %>
            <li><span class="badge bg-success me-1"><%= type.humanize %></span></li>
          <% end %>
        </ul>
      </div>
    <% elsif bonus.persisted? %>
      <p class="text-muted mt-3">No rewards configured yet.</p>
    <% end %>
  </div>
</div>

<script>
  let bonusRewardIndex = <%= bonus.persisted? ? bonus.bonus_rewards.count : 0 %>;
  let freespinRewardIndex = <%= bonus.persisted? ? bonus.freespin_rewards.count : 0 %>;
  let bonusBuyRewardIndex = <%= bonus.persisted? ? bonus.bonus_buy_rewards.count : 0 %>;
  let compPointRewardIndex = <%= bonus.persisted? ? bonus.comp_point_rewards.count : 0 %>;
  let bonusCodeRewardIndex = <%= bonus.persisted? ? bonus.bonus_code_rewards.count : 0 %>;

  // Helper functions for managing no rewards message
  function hideNoRewardsMessage() {
    const noRewardsMessage = document.getElementById('no-rewards-message');
    if (noRewardsMessage) {
      noRewardsMessage.style.display = 'none';
    }
  }

  function checkAndShowNoRewardsMessage() {
    const container = document.getElementById('all-rewards-container');
    const sections = [
      'bonus-rewards-section',
      'freespin-rewards-section', 
      'bonus-buy-rewards-section',
      'comp-point-rewards-section',
      'bonus-code-rewards-section'
    ];
    
    let hasRewards = false;
    sections.forEach(sectionId => {
      const section = document.getElementById(sectionId);
      if (section && section.children.length > 0) {
        hasRewards = true;
      }
    });
    
    const noRewardsMessage = document.getElementById('no-rewards-message');
    if (noRewardsMessage) {
      noRewardsMessage.style.display = hasRewards ? 'none' : 'block';
    }
  }

  function addBonusReward() {
    const container = document.getElementById('bonus-rewards-section');
    container.style.display = 'block';
    
    // Create basic form structure
    const formHtml = createBonusRewardFormHtml(bonusRewardIndex);
    container.insertAdjacentHTML('beforeend', formHtml);
    
    // Populate currency fields
    populateBonusRewardCurrencyFields(bonusRewardIndex);
    
    bonusRewardIndex++;
    
    hideNoRewardsMessage();
  }

  function addFreespinReward() {
    const container = document.getElementById('freespin-rewards-section');
    container.style.display = 'block';
    
    // Create basic form structure
    const formHtml = createFreespinRewardFormHtml(freespinRewardIndex);
    container.insertAdjacentHTML('beforeend', formHtml);
    
    // Populate currency fields
    populateFreespinCurrencyFields(freespinRewardIndex);
    
    freespinRewardIndex++;
    
    hideNoRewardsMessage();
  }

  function addBonusBuyReward() {
    const container = document.getElementById('bonus-buy-rewards-section');
    container.style.display = 'block';
    
    // Create basic form structure
    const formHtml = createBonusBuyRewardFormHtml(bonusBuyRewardIndex);
    container.insertAdjacentHTML('beforeend', formHtml);
    
    // Populate currency fields
    populateBonusBuyRewardCurrencyFields(bonusBuyRewardIndex);
    
    bonusBuyRewardIndex++;
    
    hideNoRewardsMessage();
  }

  function removeBonusReward(index) {
    const rewardForm = document.getElementById('bonus-reward-' + index);
    if (rewardForm) {
      rewardForm.remove();
      checkAndShowNoRewardsMessage();
    }
  }

  function removeFreespinReward(index) {
    const rewardForm = document.getElementById('freespin-reward-' + index);
    if (rewardForm) {
      rewardForm.remove();
      checkAndShowNoRewardsMessage();
    }
  }

  function removeBonusBuyReward(index) {
    const rewardForm = document.getElementById('bonus-buy-reward-' + index);
    if (rewardForm) {
      rewardForm.remove();
      checkAndShowNoRewardsMessage();
    }
  }

  // Fallback form creation functions (complete HTML templates)
  function createBonusRewardFormHtml(index) {
    return `
      <div class="card mb-3" id="bonus-reward-${index}">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Cash Bonus #${index + 1}</h6>
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeBonusReward(${index})">
            <i class="fas fa-trash"></i> Remove
          </button>
        </div>
        <div class="card-body">
          <!-- Main frequently used parameters -->
          <div class="main-params-container">
            <h6 class="text-primary reward-section-header">Main parameters</h6>
            
            <!-- Bonus type -->
            <div class="reward-button-group">
              <label class="form-label">Bonus type (bonus_type)</label>
              <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="bonus_rewards[${index}][bonus_type]" id="bonus_type_fixed_${index}" value="fixed" checked onchange="toggleBonusType('fixed', ${index})">
                <label class="btn btn-outline-primary" for="bonus_type_fixed_${index}">Fixed amount</label>
                <input type="radio" class="btn-check" name="bonus_rewards[${index}][bonus_type]" id="bonus_type_percentage_${index}" value="percentage" onchange="toggleBonusType('percentage', ${index})">
                <label class="btn btn-outline-primary" for="bonus_type_percentage_${index}">Percentage</label>
              </div>
            </div>

            <!-- Amount - Currency fields will be populated by JavaScript -->
            <div id="amount_field_${index}" class="reward-param-field full-width">
              <label class="form-label">Bonus amount by currency</label>
              <div id="currency-bonus-amounts-container-${index}">
                <div class="currency-amounts-grid" id="bonus-amounts-grid-${index}">
                  <!-- Currency fields will be populated by JavaScript -->
                </div>
              </div>
            </div>

            <!-- Percentage -->
            <div class="reward-param-field mb-3" id="percentage_field_${index}" style="display: none;">
              <label class="form-label">Percentage of deposit</label>
              <div class="input-group">
                <input type="number" class="form-control" name="bonus_rewards[${index}][percentage]" step="0.01" min="0" max="100">
                <span class="input-group-text">%</span>
              </div>
            </div>



            <!-- Code -->


            <!-- User can have duplicates -->
            <div class="reward-checkbox-field">
              <div class="form-check">
                <input type="checkbox" class="form-check-input" name="bonus_rewards[${index}][user_can_have_duplicates]" id="user_can_have_duplicates_${index}" value="true">
                <label class="form-check-label" for="user_can_have_duplicates_${index}">
                  User can have duplicates (user_can_have_duplicates)
                </label>
              </div>
            </div>

          </div>

          <!-- Advanced parameters -->
          <div class="mt-4">
            <h6 class="text-secondary mb-3">Advanced parameters</h6>
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleAdvancedParams(${index}, 'bonus')">
              <span id="advanced-params-toggle-text-${index}">Show advanced</span>
            </button>
            <div id="advanced-params-section-${index}" style="display: none;" class="mt-3">
              <div class="advanced-params-container">
                <!-- Range -->
                <div class="reward-param-field">
                  <label class="form-label">Range</label>
                  <input type="text" class="form-control" name="bonus_rewards[${index}][range]">
                </div>
                <!-- Last Login Country -->
                <div class="reward-param-field">
                  <label class="form-label">Last Login Country</label>
                  <input type="text" class="form-control" name="bonus_rewards[${index}][last_login_country]">
                </div>
                <!-- Profile Country -->
                <div class="reward-param-field">
                  <label class="form-label">Profile Country</label>
                  <input type="text" class="form-control" name="bonus_rewards[${index}][profile_country]">
                </div>
                <!-- Current IP Country -->
                <div class="reward-param-field">
                  <label class="form-label">Current IP Country</label>
                  <input type="text" class="form-control" name="bonus_rewards[${index}][current_ip_country]">
                </div>
                <!-- Emails -->
                <div class="reward-param-field">
                  <label class="form-label">Emails</label>
                  <input type="text" class="form-control" name="bonus_rewards[${index}][emails]">
                </div>
                <!-- Deposit Payment Systems -->
                <div class="reward-param-field">
                  <label class="form-label">Deposit Payment Systems</label>
                  <input type="text" class="form-control" name="bonus_rewards[${index}][deposit_payment_systems]">
                </div>
                <!-- Cashout Payment Systems -->
                <div class="reward-param-field">
                  <label class="form-label">Cashout Payment Systems</label>
                  <input type="text" class="form-control" name="bonus_rewards[${index}][cashout_payment_systems]">
                </div>
                <!-- User Can Have Disposable Email -->
                <div class="reward-checkbox-field">
                  <div class="form-check">
                    <input type="checkbox" class="form-check-input" name="bonus_rewards[${index}][user_can_have_disposable_email]" id="user_can_have_disposable_email_${index}" value="true">
                    <label class="form-check-label" for="user_can_have_disposable_email_${index}">
                      User Can Have Disposable Email
                    </label>
                  </div>
                </div>
                <!-- Total Deposits -->
                <div class="reward-param-field">
                  <label class="form-label">Total Deposits</label>
                  <input type="number" class="form-control" name="bonus_rewards[${index}][total_deposits]" step="0.01" min="0">
                </div>
                <!-- Deposits Sum -->
                <div class="reward-param-field">
                  <label class="form-label">Deposits Sum</label>
                  <input type="number" class="form-control" name="bonus_rewards[${index}][deposits_sum]" step="0.01" min="0">
                </div>
                <!-- Loss Sum -->
                <div class="reward-param-field">
                  <label class="form-label">Loss Sum</label>
                  <input type="number" class="form-control" name="bonus_rewards[${index}][loss_sum]" step="0.01" min="0">
                </div>
                <!-- Deposits Count -->
                <div class="reward-param-field">
                  <label class="form-label">Deposits Count</label>
                  <input type="number" class="form-control" name="bonus_rewards[${index}][deposits_count]" min="0">
                </div>
                <!-- Spend Sum -->
                <div class="reward-param-field">
                  <label class="form-label">Spend Sum</label>
                  <input type="number" class="form-control" name="bonus_rewards[${index}][spend_sum]" step="0.01" min="0">
                </div>
                <!-- Category Loss Sum -->
                <div class="reward-param-field">
                  <label class="form-label">Category Loss Sum</label>
                  <input type="number" class="form-control" name="bonus_rewards[${index}][category_loss_sum]" step="0.01" min="0">
                </div>
                <!-- Wager Sum -->
                <div class="reward-param-field">
                  <label class="form-label">Wager Sum</label>
                  <input type="number" class="form-control" name="bonus_rewards[${index}][wager_sum]" step="0.01" min="0">
                </div>
                <!-- Bets Count -->
                <div class="reward-param-field">
                  <label class="form-label">Bets Count</label>
                  <input type="number" class="form-control" name="bonus_rewards[${index}][bets_count]" min="0">
                </div>
                <!-- Affiliates User -->
                <div class="reward-param-field">
                  <label class="form-label">Affiliates User</label>
                  <input type="text" class="form-control" name="bonus_rewards[${index}][affiliates_user]">
                </div>
                <!-- Balance -->
                <div class="reward-param-field">
                  <label class="form-label">Balance</label>
                  <input type="number" class="form-control" name="bonus_rewards[${index}][balance]" step="0.01" min="0">
                </div>
                <!-- Cashout -->
                <div class="reward-param-field">
                  <label class="form-label">Cashout</label>
                  <input type="number" class="form-control" name="bonus_rewards[${index}][cashout]" step="0.01" min="0">
                </div>
                <!-- Chargeable Comp Points -->
                <div class="reward-param-field">
                  <label class="form-label">Chargeable Comp Points</label>
                  <input type="number" class="form-control" name="bonus_rewards[${index}][chargeable_comp_points]" step="0.01" min="0">
                </div>
                <!-- Persistent Comp Points -->
                <div class="reward-param-field">
                  <label class="form-label">Persistent Comp Points</label>
                  <input type="number" class="form-control" name="bonus_rewards[${index}][persistent_comp_points]" step="0.01" min="0">
                </div>
                <!-- Date of Birth -->
                <div class="reward-param-field">
                  <label class="form-label">Date of Birth</label>
                  <input type="date" class="form-control" name="bonus_rewards[${index}][date_of_birth]">
                </div>
                <!-- Deposit -->
                <div class="reward-param-field">
                    <label class="form-label">Deposit</label>
                    <input type="number" class="form-control" name="bonus_rewards[${index}][deposit]" step="0.01" min="0">
                  </div>
                  <!-- Gender -->
                  <div class="reward-param-field">
                    <label class="form-label">Gender</label>
                    <select class="form-select" name="bonus_rewards[${index}][gender]">
                      <option value="">Not set</option>
                      <option value="male">Male</option>
                      <option value="female">Female</option>
                    </select>
                  </div>
                  <!-- Issued Bonus -->
                  <div class="reward-param-field">
                    <label class="form-label">Issued Bonus</label>
                    <input type="text" class="form-control" name="bonus_rewards[${index}][issued_bonus]">
                  </div>
                  <!-- Registered -->
                  <div class="reward-param-field">
                    <label class="form-label">Registered</label>
                    <input type="date" class="form-control" name="bonus_rewards[${index}][registered]">
                  </div>
                  <!-- Social Networks -->
                  <div class="reward-param-field">
                    <label class="form-label">Social Networks</label>
                    <input type="text" class="form-control" name="bonus_rewards[${index}][social_networks]" >
                  </div>
                  <!-- Hold min -->
                  <div class="reward-param-field">
                    <label class="form-label">Hold min</label>
                    <input type="number" class="form-control" name="bonus_rewards[${index}][hold_min]" step="0.01" min="0">
                  </div>
                  <!-- Hold max -->
                  <div class="reward-param-field">
                    <label class="form-label">Hold max</label>
                    <input type="number" class="form-control" name="bonus_rewards[${index}][hold_max]" step="0.01" min="0">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function createFreespinRewardFormHtml(index) {
    return `
      <div class="card mb-3" id="freespin-reward-${index}">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Freespin Reward #${index + 1}</h6>
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFreespinReward(${index})">
            <i class="fas fa-trash"></i> Remove
          </button>
        </div>
        <div class="card-body">
          <!-- Main frequently used parameters -->
          <div class="main-params-container" style="display: grid !important; grid-template-columns: repeat(4, 1fr) !important; gap: 1rem !important; width: 100% !important;">
            <h6 class="text-success reward-section-header">Main parameters</h6>
            
            <!-- Games -->
            <div class="reward-param-field full-width">
              <label class="form-label">Games (games)</label>
              <input type="text" class="form-control" name="freespin_rewards[${index}][games]" >
              <!--Список доступных игр через запятую-->
            </div>

            <!-- Freespins Count -->
            <div class="reward-param-field">
              <label class="form-label">Freespins count *</label>
              <input type="number" class="form-control" name="freespin_rewards[${index}][spins_count]" min="1" required >
            </div>

            <!-- Bet Level -->
            <div class="reward-param-field">
              <label class="form-label">Bet level (bet_level)</label>
              <input type="number" class="form-control" name="freespin_rewards[${index}][bet_level]" min="0" step="0.01" >
            </div>

            <!-- Code -->


          </div>

          <!-- Currency Freespin Bet Levels - separate section -->
          <div class="currency-bet-levels-section mt-3">
            <div class="reward-param-field full-width">
              <label class="form-label">Freespin bet level by currency *</label>
              <div id="currency-freespin-bet-levels-container-${index}">
                <div class="currency-bet-levels-grid" id="freespin-bet-levels-grid-${index}">
                  <!-- Currency fields will be populated by JavaScript -->
                </div>
              </div>
            </div>
          </div>

          <!-- Note: Usage Limitations are configured in Basic Information -->
          </div>

          <!-- Advanced parameters -->
          <div class="mt-4">
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleAdvancedParams(${index}, 'freespin')">
              <span id="freespin-advanced-toggle-text-${index}">+ Show advanced parameters</span>
            </button>
            <div id="freespin-advanced-params-${index}" style="display: none;" class="mt-3">
              <div class="card">
                <div class="card-header">
                  <h6 class="card-title mb-0">Advanced parameters</h6>
                </div>
                <div class="card-body">
                  <div class="advanced-params-container">
                  <!-- Auto Activate -->
                  <div class="reward-param-field">
                    <div class="form-check">
                      <input type="checkbox" class="form-check-input" name="freespin_rewards[${index}][auto_activate]" id="auto_activate_${index}" value="true">
                      <label class="form-check-label" for="auto_activate_${index}">
                        Auto Activate
                      </label>
                    </div>
                  </div>
                  
                  <!-- Duration -->
                  <div class="reward-param-field">
                    <label class="form-label">Duration</label>
                    <input type="number" class="form-control" name="freespin_rewards[${index}][duration]" min="0" >
                    <!--Длительность в часах</div>
                  </div>

                  <!-- Activation Duration -->
                  <div class="reward-param-field">
                    <label class="form-label">Activation Duration</label>
                    <input type="number" class="form-control" name="freespin_rewards[${index}][activation_duration]" min="0" >
                    <!--Время на активацию в часах</div>
                  </div>

                  <!-- Email Template -->
                  <div class="reward-param-field">
                    <label class="form-label">Email Template</label>
                    <input type="text" class="form-control" name="freespin_rewards[${index}][email_template]">
                  </div>

                  <!-- Range -->
                  <div class="reward-param-field">
                    <label class="form-label">Range</label>
                    <input type="text" class="form-control" name="freespin_rewards[${index}][range]">
                  </div>

                  <!-- Last Login Country -->
                  <div class="reward-param-field">
                    <label class="form-label">Last Login Country</label>
                    <input type="text" class="form-control" name="freespin_rewards[${index}][last_login_country]">
                  </div>

                  <!-- Profile Country -->
                  <div class="reward-param-field">
                    <label class="form-label">Profile Country</label>
                    <input type="text" class="form-control" name="freespin_rewards[${index}][profile_country]">
                  </div>

                  <!-- Current IP Country -->
                  <div class="reward-param-field">
                    <label class="form-label">Current IP Country</label>
                    <input type="text" class="form-control" name="freespin_rewards[${index}][current_ip_country]">
                  </div>

                  <!-- Emails -->
                  <div class="reward-param-field full-width">
                    <label class="form-label">Emails</label>
                    <input type="text" class="form-control" name="freespin_rewards[${index}][emails]">
                  </div>

                  <!-- Deposit Payment Systems -->
                  <div class="reward-param-field full-width">
                    <label class="form-label">Deposit Payment Systems</label>
                    <input type="text" class="form-control" name="freespin_rewards[${index}][deposit_payment_systems]">
                  </div>

                  <!-- Cashout Payment Systems -->
                  <div class="reward-param-field full-width">
                    <label class="form-label">Cashout Payment Systems</label>
                    <input type="text" class="form-control" name="freespin_rewards[${index}][cashout_payment_systems]">
                  </div>

                  <!-- User Can Have Duplicates -->
                  <div class="reward-param-field">
                    <div class="form-check">
                      <input type="checkbox" class="form-check-input" name="freespin_rewards[${index}][user_can_have_duplicates]" id="user_can_have_duplicates_freespin_${index}" value="true">
                      <label class="form-check-label" for="user_can_have_duplicates_freespin_${index}">
                        User Can Have Duplicates
                      </label>
                    </div>
                  </div>

                  <!-- User Can Have Disposable Email -->
                  <div class="reward-param-field">
                    <div class="form-check">
                      <input type="checkbox" class="form-check-input" name="freespin_rewards[${index}][user_can_have_disposable_email]" id="user_can_have_disposable_email_freespin_${index}" value="true">
                      <label class="form-check-label" for="user_can_have_disposable_email_freespin_${index}">
                        User Can Have Disposable Email
                      </label>
                    </div>
                  </div>

                  <!-- Total Deposits -->
                  <div class="reward-param-field">
                    <label class="form-label">Total Deposits</label>
                    <input type="number" class="form-control" name="freespin_rewards[${index}][total_deposits]" step="0.01" min="0">
                  </div>

                  <!-- Deposits Sum -->
                  <div class="reward-param-field">
                    <label class="form-label">Deposits Sum</label>
                    <input type="number" class="form-control" name="freespin_rewards[${index}][deposits_sum]" step="0.01" min="0">
                  </div>

                  <!-- Loss Sum -->
                  <div class="reward-param-field">
                    <label class="form-label">Loss Sum</label>
                    <input type="number" class="form-control" name="freespin_rewards[${index}][loss_sum]" step="0.01" min="0">
                  </div>

                  <!-- Deposits Count -->
                  <div class="reward-param-field">
                    <label class="form-label">Deposits Count</label>
                    <input type="number" class="form-control" name="freespin_rewards[${index}][deposits_count]" min="0">
                  </div>
                  <!-- Spend Sum -->
                  <div class="reward-param-field">
                    <label class="form-label">Spend Sum</label>
                    <input type="number" class="form-control" name="freespin_rewards[${index}][spend_sum]" step="0.01" min="0">
                  </div>

                  <!-- Category Loss Sum -->
                  <div class="reward-param-field">
                    <label class="form-label">Category Loss Sum</label>
                    <input type="number" class="form-control" name="freespin_rewards[${index}][category_loss_sum]" step="0.01" min="0">
                  </div>

                  <!-- Wager Sum -->
                  <div class="reward-param-field">
                    <label class="form-label">Wager Sum</label>
                    <input type="number" class="form-control" name="freespin_rewards[${index}][wager_sum]" step="0.01" min="0">
                  </div>

                  <!-- Bets Count -->
                  <div class="reward-param-field">
                    <label class="form-label">Bets Count</label>
                    <input type="number" class="form-control" name="freespin_rewards[${index}][bets_count]" min="0">
                  </div>

                  <!-- Affiliates User -->
                  <div class="reward-param-field full-width">
                    <label class="form-label">Affiliates User</label>
                    <input type="text" class="form-control" name="freespin_rewards[${index}][affiliates_user]">
                  </div>

                  <!-- Balance -->
                  <div class="reward-param-field">
                    <label class="form-label">Balance</label>
                    <input type="number" class="form-control" name="freespin_rewards[${index}][balance]" step="0.01" min="0">
                  </div>

                  <!-- Stag -->
                  <div class="reward-param-field">
                    <label class="form-label">Stag</label>
                    <input type="text" class="form-control" name="freespin_rewards[${index}][stag]">
                  </div>

                  <!-- Chargeable Comp Points -->
                  <div class="reward-param-field">
                    <label class="form-label">Chargeable Comp Points</label>
                    <input type="number" class="form-control" name="freespin_rewards[${index}][chargeable_comp_points]" step="0.01" min="0">
                  </div>

                  <!-- Persistent Comp Points -->
                  <div class="reward-param-field">
                    <label class="form-label">Persistent Comp Points</label>
                    <input type="number" class="form-control" name="freespin_rewards[${index}][persistent_comp_points]" step="0.01" min="0">
                  </div>

                  <!-- Date of Birth -->
                  <div class="reward-param-field full-width">
                    <label class="form-label">Date of Birth</label>
                    <input type="date" class="form-control" name="freespin_rewards[${index}][date_of_birth]">
                  </div>

                  <!-- Deposit -->
                  <div class="reward-param-field">
                    <label class="form-label">Deposit</label>
                    <input type="number" class="form-control" name="freespin_rewards[${index}][deposit]" step="0.01" min="0">
                  </div>

                  <!-- Gender -->
                  <div class="reward-param-field">
                    <label class="form-label">Gender</label>
                    <select class="form-select" name="freespin_rewards[${index}][gender]">
                      <option value="">Not set</option>
                      <option value="male">Male</option>
                      <option value="female">Female</option>
                    </select>
                  </div>

                  <!-- Issued Bonus -->
                  <div class="reward-param-field full-width">
                    <label class="form-label">Issued Bonus</label>
                    <input type="text" class="form-control" name="freespin_rewards[${index}][issued_bonus]">
                  </div>

                  <!-- Registered -->
                  <div class="reward-param-field full-width">
                    <label class="form-label">Registered</label>
                    <input type="date" class="form-control" name="freespin_rewards[${index}][registered]">
                  </div>

                  <!-- Social Networks -->
                  <div class="reward-param-field full-width">
                    <label class="form-label">Social Networks</label>
                    <input type="text" class="form-control" name="freespin_rewards[${index}][social_networks]" >
                  </div>

                  <!-- Wager Done -->
                  <div class="reward-param-field">
                    <label class="form-label">Wager Done</label>
                    <select class="form-select" name="freespin_rewards[${index}][wager_done]">
                      <option value="">Not set</option>
                      <option value="true">Yes</option>
                      <option value="false">No</option>
                    </select>
                  </div>

                  <!-- Hold min -->
                  <div class="reward-param-field">
                    <label class="form-label">Hold min</label>
                    <input type="number" class="form-control" name="freespin_rewards[${index}][hold_min]" step="0.01" min="0">
                  </div>

                  <!-- Hold max -->
                  <div class="reward-param-field">
                    <label class="form-label">Hold max</label>
                    <input type="number" class="form-control" name="freespin_rewards[${index}][hold_max]" step="0.01" min="0">
                  </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // Populate currency fields for freespin rewards
  function populateFreespinCurrencyFields(index) {
    const grid = document.getElementById(`freespin-bet-levels-grid-${index}`);
    if (!grid) return;

    const availableCurrencies = window.currentProjectCurrencies || [];
    const cryptoCurrencies = window.currentProjectCryptoCurrencies || [];
    
    // Получаем валюты по приоритету: минимальные депозиты > выбранные валюты > все валюты
    let currenciesToUse = availableCurrencies;
    
    // Проверяем валюты из минимальных депозитов
    const minimumDepositInputs = document.querySelectorAll('input[name^="bonus[currency_minimum_deposits]"]');
    const minimumDepositCurrencies = Array.from(minimumDepositInputs)
      .map(input => {
        const match = input.name.match(/currency_minimum_deposits\[([^\]]+)\]/);
        return match ? match[1] : null;
      })
      .filter(currency => currency !== null);
    
    // Проверяем выбранные валюты
    const currencyCheckboxes = document.querySelectorAll('input.currency-checkbox:checked');
    const selectedCurrencies = Array.from(currencyCheckboxes).map(checkbox => checkbox.value);
    
    // Приоритет валют
    if (minimumDepositCurrencies.length > 0) {
      currenciesToUse = minimumDepositCurrencies;
    } else if (selectedCurrencies.length > 0) {
      currenciesToUse = selectedCurrencies;
    }

    // Clear existing fields first
    grid.innerHTML = '';

    currenciesToUse.forEach(currency => {
      const isCrypto = cryptoCurrencies.includes(currency);
      const step = isCrypto ? '0.00000001' : '0.01';
      const placeholder = isCrypto ? '0.00000000' : '0.00';
      const precision = isCrypto ? 8 : 2;

      const fieldHtml = `
        <div class="currency-bet-level-item">
          <div class="input-group">
            <span class="input-group-text">${currency}</span>
            <input type="number" 
                   name="freespin_rewards[${index}][currency_freespin_bet_levels][${currency}]"
                   class="form-control currency-input"
                   step="${step}"
                   min="0"
                   placeholder="${placeholder}"
                   data-currency="${currency}"
                   data-precision="${precision}"
                   data-currency-validation-target="input"
                   required>
          </div>
        </div>
      `;

      grid.insertAdjacentHTML('beforeend', fieldHtml);
    });
    
    // Ensure all new input fields are properly enabled and focusable
    setTimeout(() => {
      grid.querySelectorAll('input[type="number"]').forEach(input => {
        input.removeAttribute('disabled');
        input.removeAttribute('readonly');
        input.style.pointerEvents = 'auto';
      });
    }, 50);
  }

  // Populate currency fields for bonus rewards
  function populateBonusRewardCurrencyFields(index) {
    const grid = document.getElementById(`bonus-amounts-grid-${index}`);
    if (!grid) return;

    const availableCurrencies = window.currentProjectCurrencies || [];
    const cryptoCurrencies = window.currentProjectCryptoCurrencies || [];
    
    // Получаем валюты по приоритету: минимальные депозиты > выбранные валюты > все валюты
    let currenciesToUse = availableCurrencies;
    
    // Проверяем валюты из минимальных депозитов
    const minimumDepositInputs = document.querySelectorAll('input[name^="bonus[currency_minimum_deposits]"]');
    const minimumDepositCurrencies = Array.from(minimumDepositInputs)
      .map(input => {
        const match = input.name.match(/currency_minimum_deposits\[([^\]]+)\]/);
        return match ? match[1] : null;
      })
      .filter(currency => currency !== null);
    
    // Проверяем выбранные валюты
    const currencyCheckboxes = document.querySelectorAll('input.currency-checkbox:checked');
    const selectedCurrencies = Array.from(currencyCheckboxes).map(checkbox => checkbox.value);
    
    // Приоритет валют
    if (minimumDepositCurrencies.length > 0) {
      currenciesToUse = minimumDepositCurrencies;
    } else if (selectedCurrencies.length > 0) {
      currenciesToUse = selectedCurrencies;
    }

    // Clear existing fields first
    grid.innerHTML = '';

    currenciesToUse.forEach(currency => {
      const isCrypto = cryptoCurrencies.includes(currency);
      const step = isCrypto ? '0.00000001' : '0.01';
      const placeholder = isCrypto ? '0.00000000' : '0.00';
      const precision = isCrypto ? 8 : 2;

      const fieldHtml = `
        <div class="currency-amount-item">
          <div class="input-group">
            <span class="input-group-text">${currency}</span>
            <input type="number" 
                   name="bonus_rewards[${index}][currency_amounts][${currency}]"
                   class="form-control currency-input"
                   step="${step}"
                   min="0"
                   placeholder="${placeholder}"
                   data-currency="${currency}"
                   data-precision="${precision}"
                   data-currency-validation-target="input"
                   required>
          </div>
        </div>
      `;

      grid.insertAdjacentHTML('beforeend', fieldHtml);
    });
    
    // Ensure all new input fields are properly enabled and focusable
    setTimeout(() => {
      grid.querySelectorAll('input[type="number"]').forEach(input => {
        input.removeAttribute('disabled');
        input.removeAttribute('readonly');
        input.style.pointerEvents = 'auto';
      });
    }, 50);
  }

  // Populate currency fields for bonus buy rewards
  function populateBonusBuyRewardCurrencyFields(index) {
    const grid = document.getElementById(`bonus-buy-bet-levels-grid-${index}`);
    if (!grid) return;

    const availableCurrencies = window.currentProjectCurrencies || [];
    const cryptoCurrencies = window.currentProjectCryptoCurrencies || [];
    
    // Получаем валюты по приоритету: минимальные депозиты > выбранные валюты > все валюты
    let currenciesToUse = availableCurrencies;
    
    // Проверяем валюты из минимальных депозитов
    const minimumDepositInputs = document.querySelectorAll('input[name^="bonus[currency_minimum_deposits]"]');
    const minimumDepositCurrencies = Array.from(minimumDepositInputs)
      .map(input => {
        const match = input.name.match(/currency_minimum_deposits\[([^\]]+)\]/);
        return match ? match[1] : null;
      })
      .filter(currency => currency !== null);
    
    // Проверяем выбранные валюты
    const currencyCheckboxes = document.querySelectorAll('input.currency-checkbox:checked');
    const selectedCurrencies = Array.from(currencyCheckboxes).map(checkbox => checkbox.value);
    
    // Приоритет валют
    if (minimumDepositCurrencies.length > 0) {
      currenciesToUse = minimumDepositCurrencies;
    } else if (selectedCurrencies.length > 0) {
      currenciesToUse = selectedCurrencies;
    }

    // Clear existing fields first
    grid.innerHTML = '';

    currenciesToUse.forEach(currency => {
      const isCrypto = cryptoCurrencies.includes(currency);
      const step = isCrypto ? '0.00000001' : '0.01';
      const placeholder = isCrypto ? '0.00000000' : '0.00';
      const precision = isCrypto ? 8 : 2;

      const fieldHtml = `
        <div class="currency-bet-level-item">
          <div class="input-group">
            <span class="input-group-text">${currency}</span>
            <input type="number" 
                   name="bonus_buy_rewards[${index}][currency_bet_levels][${currency}]"
                   class="form-control currency-input"
                   step="${step}"
                   min="0"
                   placeholder="${placeholder}"
                   data-currency="${currency}"
                   data-precision="${precision}"
                   data-currency-validation-target="input"
                   required>
          </div>
        </div>
      `;

      grid.insertAdjacentHTML('beforeend', fieldHtml);
    });
  }

  // JavaScript helper functions for bonus rewards
  function toggleBonusType(type, index) {
    const amountField = document.getElementById('amount_field_' + index);
    const percentageField = document.getElementById('percentage_field_' + index);
    
    if (type === 'fixed') {
      amountField.style.display = 'block';
      percentageField.style.display = 'none';
      amountField.querySelectorAll('input').forEach(input => input.setAttribute('required', 'required'));
      percentageField.querySelectorAll('input').forEach(input => input.removeAttribute('required'));
    } else {
      amountField.style.display = 'none';
      percentageField.style.display = 'block';
      amountField.querySelectorAll('input').forEach(input => input.removeAttribute('required'));
      percentageField.querySelectorAll('input').forEach(input => input.setAttribute('required', 'required'));
    }
  }



  function toggleAdvancedParams(index, type) {
    let sectionId, toggleTextId;
    
    if (type === 'bonus') {
      sectionId = 'advanced-params-section-' + index;
      toggleTextId = 'advanced-params-toggle-text-' + index;
    } else if (type === 'freespin') {
      sectionId = 'freespin-advanced-params-' + index;
      toggleTextId = 'freespin-advanced-toggle-text-' + index;
    } else if (type === 'bonus_buy') {
      sectionId = 'bonus-buy-advanced-params-' + index;
      toggleTextId = 'bonus-buy-advanced-toggle-text-' + index;
    }
    
    const section = document.getElementById(sectionId);
    const toggleText = document.getElementById(toggleTextId);
    
    if (section.style.display === 'none') {
      section.style.display = 'block';
      if (type === 'bonus') {
        toggleText.textContent = 'Hide advanced';
      } else if (type === 'freespin') {
        toggleText.textContent = '− Hide advanced parameters';
      } else if (type === 'bonus_buy') {
        toggleText.textContent = '− Hide advanced parameters';
      }
    } else {
      section.style.display = 'none';
      if (type === 'bonus') {
        toggleText.textContent = 'Show advanced';
      } else if (type === 'freespin') {
        toggleText.textContent = '+ Show advanced parameters';
      } else if (type === 'bonus_buy') {
        toggleText.textContent = '+ Show advanced parameters';
      }
    }
  }



  // Comp Point Rewards Functions
  function addCompPointReward() {
    const container = document.getElementById('comp-point-rewards-section');
    container.style.display = 'block';
    
    // Create basic form structure
    const formHtml = createCompPointRewardFormHtml(compPointRewardIndex);
    container.insertAdjacentHTML('beforeend', formHtml);
    compPointRewardIndex++;
    
    hideNoRewardsMessage();
  }

  function removeCompPointReward(index) {
    const rewardForm = document.getElementById(`comp-point-reward-${index}`);
    if (rewardForm) {
      rewardForm.remove();
      checkAndShowNoRewardsMessage();
    }
  }

  function createBonusBuyRewardFormHtml(index) {
    return `
      <div class="card mb-3" id="bonus-buy-reward-${index}">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Bonus Buy Reward #${index + 1}</h6>
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeBonusBuyReward(${index})">
            <i class="fas fa-trash"></i> Remove
          </button>
        </div>
        <div class="card-body">
          <!-- Main parameters -->
          <div class="main-params-container">
            <h6 class="text-warning reward-section-header">Main parameters</h6>
            
            <!-- Buy Amount -->
            <div class="reward-param-field">
              <label class="form-label">Purchase amount (buy_amount) *</label>
              <div class="input-group">
                <input type="number" class="form-control" name="bonus_buy_rewards[${index}][buy_amount]" min="1"  required>
                <span class="input-group-text">€</span>
              </div>
              <!--Сумма которую игрок должен заплатить за покупку бонуса-->
            </div>

            <!-- Multiplier -->
            <div class="reward-param-field">
              <label class="form-label">Purchase multiplier (multiplier)</label>
              <div class="input-group">
                <input type="number" class="form-control" name="bonus_buy_rewards[${index}][multiplier]" min="1" step="0.1" >
                <span class="input-group-text">x</span>
              </div>
              <!--Множитель от ставки для расчета покупки-->
            </div>

            <!-- Games -->
            <div class="reward-param-field mb-3 full-width">
              <label class="form-label">Games (games)</label>
              <input type="text" class="form-control" name="bonus_buy_rewards[${index}][games]" >
              <!--Список доступных игр через запятую-->
            </div>

            <!-- Bet Level -->
            <div class="reward-param-field">
              <label class="form-label">Bet level (bet_level)</label>
              <div class="input-group">
                <input type="number" class="form-control" name="bonus_buy_rewards[${index}][bet_level]" min="0" step="0.01" >
                <span class="input-group-text">€</span>
              </div>
              <!--Размер ставки за покупку-->
            </div>



            <!-- Code -->


            <!-- Tags -->
            <div class="reward-param-field">
              <label class="form-label">Tags (tags)</label>
              <input type="text" class="form-control" name="bonus_buy_rewards[${index}][tags]" placeholder="bonus-buy, promo, special">
            </div>

            <!-- Note: Currencies, Groups, Tags, Usage Limitations, Minimum Deposit, and Wagering Strategy are configured in Basic Information -->
          </div>

          <!-- Advanced parameters -->
          <div class="mt-4">
            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleAdvancedParams(${index}, 'bonus_buy')">
              <span id="bonus-buy-advanced-toggle-text-${index}">+ Show advanced parameters</span>
            </button>
            <div id="bonus-buy-advanced-params-${index}" style="display: none;" class="mt-3">
              <h6 class="text-secondary mb-3">Advanced parameters</h6>
              <div class="row">
                <div class="col-md-6">
                  <!-- Stag -->
                  <div class="reward-param-field">
                    <label class="form-label">Stag</label>
                    <input type="text" class="form-control" name="bonus_buy_rewards[${index}][stag]">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function createCompPointRewardFormHtml(index) {
    return `
      <div class="card mb-3" id="comp-point-reward-${index}">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Comp Point Reward #${index + 1}</h6>
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeCompPointReward(${index})">
            <i class="fas fa-trash"></i> Remove
          </button>
        </div>
        <div class="card-body">
          <!-- Main parameters -->
          <div class="main-params-container">
            <h6 class="text-info reward-section-header">Main parameters</h6>
            
            <!-- Title -->
            <div class="reward-param-field mb-3 full-width">
              <label class="form-label">Reward name (title) *</label>
              <input type="text" class="form-control" name="comp_point_rewards[${index}][title]" placeholder="Loyalty points" required>
              <!--Описательное название для награды-->
            </div>

            <!-- Points Amount -->
            <div class="reward-param-field">
              <label class="form-label">Points amount (points_amount) *</label>
              <input type="number" class="form-control" name="comp_point_rewards[${index}][points_amount]" min="0" required>
              <!--Количество очков, которые получит игрок-->
            </div>

            <!-- Multiplier -->
            <div class="reward-param-field">
              <label class="form-label">Multiplier (multiplier)</label>
              <input type="number" class="form-control" name="comp_point_rewards[${index}][multiplier]" min="0" step="0.01">
              <!--Опциональный множитель очков-->
            </div>

            <!-- Note: Currencies, Groups, Tags, Usage Limitations, Minimum Deposit, and Wagering Strategy are configured in Basic Information -->
          </div>
        </div>
      </div>
    `;
  }

  // Bonus Code Rewards Functions
  function addBonusCodeReward() {
    const container = document.getElementById('bonus-code-rewards-section');
    container.style.display = 'block';
    
    // Create basic form structure
    const formHtml = createBonusCodeRewardFormHtml(bonusCodeRewardIndex);
    container.insertAdjacentHTML('beforeend', formHtml);
    bonusCodeRewardIndex++;
    
    hideNoRewardsMessage();
  }

  function removeBonusCodeReward(index) {
    const rewardForm = document.getElementById(`bonus-code-reward-${index}`);
    if (rewardForm) {
      rewardForm.remove();
      checkAndShowNoRewardsMessage();
    }
  }

  function createBonusCodeRewardFormHtml(index) {
    return `
      <div class="card mb-3" id="bonus-code-reward-${index}">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Bonus Code Reward #${index + 1}</h6>
          <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeBonusCodeReward(${index})">
            <i class="fas fa-trash"></i> Remove
          </button>
        </div>
        <div class="card-body">
          <!-- Main parameters -->
          <div class="main-params-container">
            <h6 class="text-secondary reward-section-header">Main parameters</h6>
            
            <!-- Title -->
            <div class="reward-param-field mb-3 full-width">
              <label class="form-label">Reward name (title) *</label>
              <input type="text" class="form-control" name="bonus_code_rewards[${index}][title]" placeholder="Deposit bonus code" required>
              <!--Описательное название для награды-->
            </div>

            <!-- Set Bonus Code -->
            <div class="reward-param-field mb-3 full-width">
              <label class="form-label">Bonus code (set_bonus_code) *</label>
              <input type="text" class="form-control" name="bonus_code_rewards[${index}][set_bonus_code]" placeholder="WELCOME100" required>
              <!--Бонус-код, который будет применен в профиле игрока-->
            </div>

            <!-- Note: Currencies, Groups, Tags, Usage Limitations, Minimum Deposit, and Wagering Strategy are configured in Basic Information -->

            <!-- Information about collect strategy -->
            <div class="alert alert-warning full-width">
              <small>
                Collect strategy:<br>
                This reward type works with bonuses using the "collect" strategy.
              </small>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // Function to clear all currency fields in type-specific forms
  function clearAllCurrencyFields() {
    // Clear freespin bet levels
    const freespinGrids = document.querySelectorAll('[id^="freespin-bet-levels-grid-"]');
    freespinGrids.forEach(grid => {
      grid.innerHTML = '';
    });

    // Clear bonus amounts
    const bonusAmountsGrids = document.querySelectorAll('[id^="bonus-amounts-grid-"]');
    bonusAmountsGrids.forEach(grid => {
      grid.innerHTML = '';
    });

    // Clear bonus buy bet levels
    const bonusBuyGrids = document.querySelectorAll('[id^="bonus-buy-bet-levels-grid-"]');
    bonusBuyGrids.forEach(grid => {
      grid.innerHTML = '';
    });

    // Clear freechip amounts
    const freechipGrids = document.querySelectorAll('[id^="freechip-amounts-grid-"]');
    freechipGrids.forEach(grid => {
      grid.innerHTML = '';
    });

    // Clear comp point amounts
    const compPointGrids = document.querySelectorAll('[id^="comp-point-amounts-grid-"]');
    compPointGrids.forEach(grid => {
      grid.innerHTML = '';
    });

    // Clear material prize amounts
    const materialPrizeGrids = document.querySelectorAll('[id^="material-prize-amounts-grid-"]');
    materialPrizeGrids.forEach(grid => {
      grid.innerHTML = '';
    });
  }

  // Make function globally available
  window.clearAllCurrencyFields = clearAllCurrencyFields;
</script>
