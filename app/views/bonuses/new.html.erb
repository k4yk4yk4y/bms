<% content_for :title, "New Bonus" %>

<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">Create New Bonus</h1>
        <%= link_to "Back to List", bonuses_path, class: "btn btn-outline-secondary" %>
      </div>

      <%= form_with model: @bonus, local: true, class: "needs-validation", novalidate: true, 
          data: { 
            controller: "currency-validation currency", 
            action: "submit->currency-validation#validateForm" 
          } do |form| %>
        <% if @bonus.errors.any? %>
          <div class="alert alert-danger">
            <h4><%= pluralize(@bonus.errors.count, "error") %> prohibited this bonus from being saved:</h4>
            <ul class="mb-0">
              <% @bonus.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <div class="row">
          <!-- Левая колонка: Basic Information -->
          <div class="col-lg-4">
            <!-- Basic Information -->
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="card-title mb-0">Basic Information</h5>
                <!-- Template Status Indicator -->
                <div id="template-status" class="mt-2" style="display: none;">
                  <div id="template-loading" class="alert alert-info py-1 px-2 mb-0" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> Searching for template...
                  </div>
                  <div id="template-found" class="alert alert-success py-1 px-2 mb-0" style="display: none;">
                    <i class="fas fa-check"></i> <span id="template-found-message">Template applied</span>
                  </div>
                  <div id="template-not-found" class="alert alert-warning py-1 px-2 mb-0" style="display: none;">
                    <i class="fas fa-info-circle"></i> No template found for these parameters
                  </div>
                </div>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <%= form.label :name, class: "form-label" %>
                  <%= form.text_field :name, class: "form-control", required: true, 
                      oninput: "searchTemplate()" %>
                </div>

                <div class="mb-3">
                  <%= form.label :code, "Bonus Code", class: "form-label" %>
                  <%= form.text_field :code, class: "form-control", 
                      placeholder: "Enter bonus code (max 50 characters)" %>
                </div>

                <div class="mb-3">
                  <%= form.label :description, class: "form-label" %>
                  <%= form.text_area :description, class: "form-control", rows: 3, placeholder: "Описание бонуса..." %>
                </div>

                <div class="mb-3">
                  <%= form.label :event, class: "form-label" %>
                  <%= form.select :event, event_type_options, 
                      { selected: @event_type }, 
                      { class: "form-select", required: true, 
                        onchange: "toggleTypeSpecificFields(this.value)" } %>
                </div>

                <div class="mb-3">
                  <%= form.label :status, class: "form-label" %>
                  <%= form.select :status, status_options, 
                      { selected: 'draft' }, 
                      { class: "form-select", required: true } %>
                </div>

                <div class="mb-3">
                  <%= form.label :project, class: "form-label" %>
                  <%= form.select :project, project_options, 
                      { include_blank: "Select project" }, 
                      { class: "form-select", onchange: "searchTemplate()" } %>
                </div>

                <div class="mb-3">
                  <%= form.label :dsl_tag, class: "form-label" %>
                  <%= form.text_field :dsl_tag, class: "form-control", 
                      oninput: "searchTemplate()" %>
                </div>

                <div class="mb-3">
                  <%= form.label :currencies, "Currencies", class: "form-label" %>
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted">Выберите валюты для бонуса</small>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="uncheck-all-currencies-btn" 
                            data-action="click->currency#uncheckAll">
                      <i class="bi bi-check2-all"></i> Снять все
                    </button>

                  </div>
                  <div class="currencies-checkboxes border rounded p-3" style="max-height: 150px; overflow-y: auto;">
                    <% selected_currencies = @bonus.currencies.present? ? @bonus.currencies : Bonus.all_currencies %>
                    <% Bonus.all_currencies.each_with_index do |currency, index| %>
                      <div class="form-check <%= 'mb-1' unless index == Bonus.all_currencies.length - 1 %>">
                        <%= check_box_tag "bonus[currencies][]", currency, 
                            selected_currencies.include?(currency),
                            {
                              class: "form-check-input currency-checkbox",
                              id: "currency_#{currency}",
                              data: { 
                                currency: currency,
                                "currency-target": "checkbox"
                              }
                            } %>
                        <%= label_tag "currency_#{currency}", currency, class: "form-check-label" %>
                      </div>
                    <% end %>
                  </div>
                </div>

                <div class="mb-3">
                  <%= form.label :groups, "Target Groups", class: "form-label" %>
                  <%= form.text_field :groups, class: "form-control", 
                      value: @bonus.groups.is_a?(Array) ? @bonus.groups.join(', ') : @bonus.groups %>

                </div>

                <div class="mb-3">
                  <%= form.label :no_more, "Usage Limitation", class: "form-label" %>
                  <%= form.text_field :no_more, class: "form-control", 
                      value: @bonus.no_more %>

                </div>

                <div class="mb-3">
                  <%= form.label :totally_no_more, "Total Activation Limit", class: "form-label" %>
                  <%= form.number_field :totally_no_more, class: "form-control", 
                      min: 1, 
                      value: @bonus.totally_no_more %>

                </div>
              </div>
            </div>

            <!-- Currency Minimum Deposits (только для депозитных бонусов) -->
            <div id="currency-minimum-deposits-section" style="<%= 'display: none;' unless @bonus.event == 'deposit' %>">
              <%= render "currency_minimum_deposits", form: form, bonus: @bonus %>
            </div>

            <!-- Wagering Information -->
            <div class="card mb-4" id="wagering-information-card">
              <div class="card-header">
                <h5 class="card-title mb-0">Wagering Information</h5>
              </div>
              <div class="card-body">
                <div class="mb-3" id="minimum-deposit-field" style="display: none;">
                  <%= form.label :minimum_deposit, class: "form-label" %>
                  <%= form.number_field :minimum_deposit, step: 0.01, 
                      class: "form-control", min: 0 %>

                </div>

                <div class="mb-3">
                  <%= form.label :wager, class: "form-label" %>
                  <%= form.number_field :wager, step: 0.01, 
                      class: "form-control", min: 0 %>
                </div>

                <div class="mb-3">
                  <%= form.label :maximum_winnings, class: "form-label" %>
                  <div class="row">
                    <div class="col-md-4">
                      <%= form.select :maximum_winnings_type, 
                          options_for_select([
                            ['Множитель', 'multiplier'],
                            ['Фиксированное значение', 'fixed']
                          ], 'multiplier'), 
                          {}, 
                          { class: "form-select", id: "maximum_winnings_type_select" } %>
                    </div>
                    <div class="col-md-6">
                      <div class="input-group">
                        <%= form.number_field :maximum_winnings, step: 0.01, 
                            class: "form-control", min: 0, id: "maximum_winnings_input" %>
                        <span class="input-group-text" id="maximum_winnings_suffix">x</span>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="mb-3">
                  <%= form.label :wagering_strategy, class: "form-label" %>
                  <%= form.select :wagering_strategy, wagering_strategy_options, 
                      { include_blank: "Select strategy" }, 
                      { class: "form-select" } %>
                </div>
              </div>
            </div>

            <!-- Availability -->
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="card-title mb-0">Availability</h5>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <%= form.label :availability_start_date, class: "form-label" %>
                  <%= form.datetime_local_field :availability_start_date, 
                      class: "form-control", required: true,
                      value: (@bonus.availability_start_date || Time.current).strftime("%Y-%m-%dT%H:%M") %>
                </div>

                <div class="mb-3">
                  <%= form.label :availability_end_date, class: "form-label" %>
                  <%= form.datetime_local_field :availability_end_date, 
                      class: "form-control", required: true,
                      value: (@bonus.availability_end_date || 1.month.from_now).strftime("%Y-%m-%dT%H:%M") %>
                </div>
              </div>
            </div>

            <!-- Actions -->
            <div class="card">
              <div class="card-body">
                <div class="d-grid gap-2">
                  <%= form.submit "Create Bonus", class: "btn btn-primary" %>
                  <%= link_to "Cancel", bonuses_path, class: "btn btn-outline-secondary" %>
                </div>
              </div>
            </div>
          </div>

          <!-- Правая колонка: Type-Specific Fields -->
          <div class="col-lg-8">
            <!-- Type-Specific Fields -->
            <div id="type-specific-fields">
              <%= render "type_specific_form", form: form, bonus: @bonus %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>


  let templateSearchTimeout;
  let lastSearchParams = '';



  function toggleTypeSpecificFields(bonusType) {
    const minimumDepositField = document.getElementById('minimum-deposit-field');
    const currencyMinimumDepositsSection = document.getElementById('currency-minimum-deposits-section');
    
    // Типы бонусов, которые не должны показывать minimum_deposit
    const nonDepositTypes = ['input_coupon', 'manual', 'collection', 'groups_update', 'scheduler'];
    
    if (nonDepositTypes.includes(bonusType)) {
      // Скрываем поле minimum_deposit для типов, которые его не используют
      minimumDepositField.style.display = 'none';
      // Очищаем значение поля
      const minimumDepositInput = minimumDepositField.querySelector('input');
      if (minimumDepositInput) {
        minimumDepositInput.value = '';
      }
      // Скрываем секцию минимальных депозитов по валютам
      if (currencyMinimumDepositsSection) {
        currencyMinimumDepositsSection.style.display = 'none';
        // Очищаем значения полей минимальных депозитов
        const currencyInputs = currencyMinimumDepositsSection.querySelectorAll('input[type="number"]');
        currencyInputs.forEach(input => input.value = '');
      }
    } else if (bonusType === 'deposit') {
      // Для депозитных бонусов тоже скрываем старое поле, но показываем новую секцию
      minimumDepositField.style.display = 'none';
      const minimumDepositInput = minimumDepositField.querySelector('input');
      if (minimumDepositInput) {
        minimumDepositInput.value = '';
      }
      // Показываем секцию минимальных депозитов по валютам
      if (currencyMinimumDepositsSection) {
        currencyMinimumDepositsSection.style.display = 'block';
      }
    } else {
      // Показываем поле для других типов (если они появятся в будущем)
      minimumDepositField.style.display = 'block';
      // Скрываем секцию минимальных депозитов по валютам для других типов
      if (currencyMinimumDepositsSection) {
        currencyMinimumDepositsSection.style.display = 'none';
        const currencyInputs = currencyMinimumDepositsSection.querySelectorAll('input[type="number"]');
        currencyInputs.forEach(input => input.value = '');
      }
    }
    
    console.log('Selected bonus type:', bonusType);
  }

  // Auto-search template functionality
  function searchTemplate() {
    // Clear previous timeout
    if (templateSearchTimeout) {
      clearTimeout(templateSearchTimeout);
    }

    // Get current values
    const name = document.querySelector('input[name="bonus[name]"]')?.value?.trim() || '';
    const dslTag = document.querySelector('input[name="bonus[dsl_tag]"]')?.value?.trim() || '';
    const project = document.querySelector('select[name="bonus[project]"]')?.value || '';

    // Create search params string to avoid duplicate searches
    const searchParams = `${name}|${dslTag}|${project}`;
    
    // Don't search if params haven't changed
    if (searchParams === lastSearchParams) {
      return;
    }

    lastSearchParams = searchParams;

    // Only search if ALL three parameters are provided
    if (!name || !dslTag || !project) {
      console.log('Not all parameters provided, skipping search:', { name, dslTag, project });
      // Hide any existing status
      showTemplateStatus('none');
      return;
    }

    // Debounce the search (wait 500ms after user stops typing)
    templateSearchTimeout = setTimeout(async () => {
      console.log('Searching for template with all three params:', { name, dslTag, project });
      
      // Show loading state
      showTemplateStatus('loading');

      try {
        // Build API URL with all three parameters
        const apiUrl = `/bonuses/find_template?dsl_tag=${encodeURIComponent(dslTag)}&name=${encodeURIComponent(name)}&project=${encodeURIComponent(project)}`;

        console.log('API URL:', apiUrl);

        // Make request to find template
        const response = await fetch(apiUrl);
        const data = await response.json();

        if (response.ok && data.template) {
          console.log('Template found:', data);
          applyTemplate(data.template);
          showTemplateStatus('found', `Template "${data.template.name}" applied (${data.found_by})`);
        } else {
          console.log('Template not found:', data);
          showTemplateStatus('not-found');
        }
      } catch (error) {
        console.error('Error searching for template:', error);
        showTemplateStatus('not-found');
      }
    }, 500);
  }

  function applyTemplate(template) {
    console.log('Applying template:', template);

    // Apply template values to form fields
    if (template.dsl_tag && !document.querySelector('input[name="bonus[dsl_tag]"]').value) {
      document.querySelector('input[name="bonus[dsl_tag]"]').value = template.dsl_tag;
    }

    if (template.project && template.project !== 'All') {
      const projectSelect = document.querySelector('select[name="bonus[project]"]');
      if (projectSelect && !projectSelect.value) {
        projectSelect.value = template.project;
      }
    }

    if (template.event) {
      const eventSelect = document.querySelector('select[name="bonus[event]"]');
      if (eventSelect) {
        eventSelect.value = template.event;
        // Trigger the change event to update type-specific fields
        toggleTypeSpecificFields(template.event);
      }
    }

    if (template.wager) {
      const wagerInput = document.querySelector('input[name="bonus[wager]"]');
      if (wagerInput && !wagerInput.value) {
        wagerInput.value = template.wager;
      }
    }

    if (template.maximum_winnings) {
      const maxWinningsInput = document.querySelector('input[name="bonus[maximum_winnings]"]');
      if (maxWinningsInput && !maxWinningsInput.value) {
        maxWinningsInput.value = template.maximum_winnings;
      }
    }

    if (template.no_more) {
      const noMoreInput = document.querySelector('input[name="bonus[no_more]"]');
      if (noMoreInput && !noMoreInput.value) {
        noMoreInput.value = template.no_more;
      }
    }

    if (template.totally_no_more) {
      const totallyNoMoreInput = document.querySelector('input[name="bonus[totally_no_more]"]');
      if (totallyNoMoreInput && !totallyNoMoreInput.value) {
        totallyNoMoreInput.value = template.totally_no_more;
      }
    }

    if (template.groups && template.groups.length > 0) {
      const groupsInput = document.querySelector('input[name="bonus[groups]"]');
      if (groupsInput && !groupsInput.value) {
        groupsInput.value = Array.isArray(template.groups) ? template.groups.join(', ') : template.groups;
      }
    }

    if (template.description) {
      const descriptionInput = document.querySelector('textarea[name="bonus[description]"]');
      if (descriptionInput && !descriptionInput.value) {
        descriptionInput.value = template.description;
      }
    }

    if (template.currencies && template.currencies.length > 0) {
      // Clear current currency checkboxes
      const currencyCheckboxes = document.querySelectorAll('input.currency-checkbox');
      currencyCheckboxes.forEach(checkbox => checkbox.checked = false);
      
      // Select currencies from template
      const currencies = Array.isArray(template.currencies) ? template.currencies : template.currencies.split(' ');
      currencies.forEach(currency => {
        const checkbox = document.querySelector(`input.currency-checkbox[value="${currency.trim()}"]`);
        if (checkbox) {
          checkbox.checked = true;
          }
        });
      }
    }

    // Apply currency minimum deposits if present
    if (template.currency_minimum_deposits && Object.keys(template.currency_minimum_deposits).length > 0) {
      Object.entries(template.currency_minimum_deposits).forEach(([currency, amount]) => {
        const input = document.querySelector(`input[name="bonus[currency_minimum_deposits][${currency}]"]`);
        if (input && !input.value) {
          input.value = amount;
        }
      });
    }
  }

  function showTemplateStatus(status, message = '') {
    const statusContainer = document.getElementById('template-status');
    const loadingEl = document.getElementById('template-loading');
    const foundEl = document.getElementById('template-found');
    const notFoundEl = document.getElementById('template-not-found');
    const messageEl = document.getElementById('template-found-message');

    // Hide all status elements first
    loadingEl.style.display = 'none';
    foundEl.style.display = 'none';
    notFoundEl.style.display = 'none';

    switch (status) {
      case 'loading':
        statusContainer.style.display = 'block';
        loadingEl.style.display = 'block';
        break;
      case 'found':
        statusContainer.style.display = 'block';
        foundEl.style.display = 'block';
        if (message) {
          messageEl.textContent = message;
        }
        // Hide status after 3 seconds
        setTimeout(() => {
          statusContainer.style.display = 'none';
        }, 3000);
        break;
      case 'not-found':
        statusContainer.style.display = 'block';
        notFoundEl.style.display = 'block';
        // Hide status after 2 seconds
        setTimeout(() => {
          statusContainer.style.display = 'none';
        }, 2000);
        break;
      default:
        statusContainer.style.display = 'none';
    }
  }

  // Инициализируем при загрузке страницы
  document.addEventListener('DOMContentLoaded', function() {
    const bonusTypeSelect = document.querySelector('select[name="bonus[event]"]');
    if (bonusTypeSelect && bonusTypeSelect.value) {
      toggleTypeSpecificFields(bonusTypeSelect.value);
    }

    // Check if template_id is provided in URL and search for template
    const urlParams = new URLSearchParams(window.location.search);
    const templateId = urlParams.get('template_id');
    if (templateId) {
      // Template was applied via URL parameter, show success message
      showTemplateStatus('found', 'Template applied from URL');
    }

    // Maximum winnings type handler
    const maxWinningsTypeSelect = document.getElementById('maximum_winnings_type_select');
    const maxWinningsSuffix = document.getElementById('maximum_winnings_suffix');
    
    if (maxWinningsTypeSelect && maxWinningsSuffix) {
      maxWinningsTypeSelect.addEventListener('change', function() {
        if (this.value === 'multiplier') {
          maxWinningsSuffix.textContent = 'x';
        } else {
          maxWinningsSuffix.textContent = 'EUR';
        }
      });
    }
    

  });
</script>
