<% content_for :title, "New Bonus" %>

<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">Create New Bonus</h1>
        <%= link_to "Back to List", bonuses_path, class: "btn btn-outline-secondary" %>
      </div>

      <%= form_with model: @bonus, local: true, class: "needs-validation", novalidate: true do |form| %>
        <% if @bonus.errors.any? %>
          <div class="alert alert-danger">
            <h4><%= pluralize(@bonus.errors.count, "error") %> prohibited this bonus from being saved:</h4>
            <ul class="mb-0">
              <% @bonus.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <div class="row">
          <!-- Левая колонка: Basic Information -->
          <div class="col-lg-4">
            <!-- Basic Information -->
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="card-title mb-0">Basic Information</h5>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <%= form.label :name, class: "form-label" %>
                  <%= form.text_field :name, class: "form-control", required: true %>
                </div>

                <div class="mb-3">
                  <%= form.label :event, class: "form-label" %>
                  <%= form.select :event, event_type_options, 
                      { selected: @event_type }, 
                      { class: "form-select", required: true, 
                        onchange: "toggleTypeSpecificFields(this.value)" } %>
                </div>

                <div class="mb-3">
                  <%= form.label :status, class: "form-label" %>
                  <%= form.select :status, status_options, 
                      { selected: 'draft' }, 
                      { class: "form-select", required: true } %>
                </div>

                <div class="mb-3">
                  <%= form.label :project, class: "form-label" %>
                  <%= form.select :project, project_options, 
                      { include_blank: "Select project" }, 
                      { class: "form-select" } %>
                </div>

                <div class="mb-3">
                  <%= form.label :dsl_tag, class: "form-label" %>
                  <%= form.text_field :dsl_tag, class: "form-control" %>
                </div>

                <div class="mb-3">
                  <%= form.label :currencies, "Currencies", class: "form-label" %>
                  <%= form.select :currencies, 
                      options_for_select([
                        ['USD', 'USD'], ['EUR', 'EUR'], ['GBP', 'GBP'], ['RUB', 'RUB'],
                        ['UAH', 'UAH'], ['KZT', 'KZT'], ['BTC', 'BTC'], ['ETH', 'ETH']
                      ], @bonus.currencies), 
                      {}, { class: "form-select", multiple: true, 
                           size: 4, style: "height: auto;" } %>

                </div>

                <div class="mb-3">
                  <%= form.label :groups, "Target Groups", class: "form-label" %>
                  <%= form.text_field :groups, class: "form-control", 
                      value: @bonus.groups.is_a?(Array) ? @bonus.groups.join(', ') : @bonus.groups %>

                </div>

                <div class="mb-3">
                  <%= form.label :no_more, "Usage Limitation", class: "form-label" %>
                  <%= form.text_field :no_more, class: "form-control", 
                      value: @bonus.no_more %>

                </div>

                <div class="mb-3">
                  <%= form.label :totally_no_more, "Total Activation Limit", class: "form-label" %>
                  <%= form.number_field :totally_no_more, class: "form-control", 
                      min: 1, 
                      value: @bonus.totally_no_more %>

                </div>
              </div>
            </div>

            <!-- Financial Information -->
            <div class="card mb-4" id="financial-information-card">
              <div class="card-header">
                <h5 class="card-title mb-0">Financial Information</h5>
              </div>
              <div class="card-body">
                <div class="mb-3" id="minimum-deposit-field" style="display: none;">
                  <%= form.label :minimum_deposit, class: "form-label" %>
                  <%= form.number_field :minimum_deposit, step: 0.01, 
                      class: "form-control", min: 0 %>

                </div>

                <div class="mb-3">
                  <%= form.label :wager, class: "form-label" %>
                  <%= form.number_field :wager, step: 0.01, 
                      class: "form-control", min: 0 %>
                </div>

                <div class="mb-3">
                  <%= form.label :maximum_winnings, class: "form-label" %>
                  <%= form.number_field :maximum_winnings, step: 0.01, 
                      class: "form-control", min: 0 %>
                </div>

                <div class="mb-3">
                  <%= form.label :wagering_strategy, class: "form-label" %>
                  <%= form.select :wagering_strategy, wagering_strategy_options, 
                      { include_blank: "Select strategy" }, 
                      { class: "form-select" } %>
                </div>
              </div>
            </div>

            <!-- Availability -->
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="card-title mb-0">Availability</h5>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <%= form.label :availability_start_date, class: "form-label" %>
                  <%= form.datetime_local_field :availability_start_date, 
                      class: "form-control", required: true,
                      value: (@bonus.availability_start_date || Time.current).strftime("%Y-%m-%dT%H:%M") %>
                </div>

                <div class="mb-3">
                  <%= form.label :availability_end_date, class: "form-label" %>
                  <%= form.datetime_local_field :availability_end_date, 
                      class: "form-control", required: true,
                      value: (@bonus.availability_end_date || 1.month.from_now).strftime("%Y-%m-%dT%H:%M") %>
                </div>
              </div>
            </div>

            <!-- Actions -->
            <div class="card">
              <div class="card-body">
                <div class="d-grid gap-2">
                  <%= form.submit "Create Bonus", class: "btn btn-primary" %>
                  <%= link_to "Cancel", bonuses_path, class: "btn btn-outline-secondary" %>
                </div>
              </div>
            </div>
          </div>

          <!-- Правая колонка: Type-Specific Fields -->
          <div class="col-lg-8">
            <!-- Type-Specific Fields -->
            <div id="type-specific-fields">
              <%= render "type_specific_form", form: form, bonus: @bonus %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  function toggleTypeSpecificFields(bonusType) {
    const minimumDepositField = document.getElementById('minimum-deposit-field');
    const financialCard = document.getElementById('financial-information-card');
    
    // Типы бонусов, которые не должны показывать minimum_deposit
    const nonDepositTypes = ['input_coupon', 'manual', 'collection', 'groups_update', 'scheduler'];
    
    if (nonDepositTypes.includes(bonusType)) {
      // Скрываем поле minimum_deposit для типов, которые его не используют
      minimumDepositField.style.display = 'none';
      // Очищаем значение поля
      const minimumDepositInput = minimumDepositField.querySelector('input');
      if (minimumDepositInput) {
        minimumDepositInput.value = '';
      }
    } else if (bonusType === 'deposit') {
      // Для депозитных бонусов тоже скрываем, так как используется deposit_amount_required
      minimumDepositField.style.display = 'none';
      const minimumDepositInput = minimumDepositField.querySelector('input');
      if (minimumDepositInput) {
        minimumDepositInput.value = '';
      }
    } else {
      // Показываем поле для других типов (если они появятся в будущем)
      minimumDepositField.style.display = 'block';
    }
    
    console.log('Selected bonus type:', bonusType);
  }
  
  // Инициализируем при загрузке страницы
  document.addEventListener('DOMContentLoaded', function() {
    const bonusTypeSelect = document.querySelector('select[name="bonus[event]"]');
    if (bonusTypeSelect && bonusTypeSelect.value) {
      toggleTypeSpecificFields(bonusTypeSelect.value);
    }
  });
</script>
