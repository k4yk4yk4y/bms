<% content_for :title, "New Bonus" %>

<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">Create New Bonus</h1>
        <%= link_to "Back to List", bonuses_path, class: "btn btn-outline-secondary" %>
      </div>

      <%= form_with model: @bonus, local: true, class: "needs-validation", novalidate: true, 
          data: { 
            controller: "currency-validation currency bonus-template", 
            action: "submit->currency-validation#validateForm" 
          } do |form| %>
        <% if @bonus.errors.any? %>
          <div class="alert alert-danger">
            <h4><%= pluralize(@bonus.errors.count, "error") %> prohibited this bonus from being saved:</h4>
            <ul class="mb-0">
              <% @bonus.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <div class="row">
          <!-- Левая колонка: Basic Information -->
          <div class="col-lg-4">
            <!-- Basic Information -->
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="card-title mb-0">Basic Information</h5>
                <!-- Template Status Indicator -->
                <div id="template-status" class="mt-2" style="display: none;">
                  <div id="template-loading" class="alert alert-info py-1 px-2 mb-0" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> Searching for template...
                  </div>
                  <div id="template-found" class="alert alert-success py-1 px-2 mb-0" style="display: none;">
                    <i class="fas fa-check"></i> <span id="template-found-message">Template applied</span>
                  </div>
                  <div id="template-not-found" class="alert alert-warning py-1 px-2 mb-0" style="display: none;">
                    <i class="fas fa-info-circle"></i> No template found for these parameters
                  </div>
                </div>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <%= form.label :name, class: "form-label" %>
                  <%= form.text_field :name, class: "form-control", required: true, 
                      data: { "bonus-template-target": "name" } %>
                </div>

                <div class="mb-3">
                  <%= form.label :code, "Bonus Code", class: "form-label" %>
                  <%= form.text_field :code, class: "form-control", 
                      placeholder: "Enter bonus code (max 50 characters)" %>
                </div>

                <div class="mb-3">
                  <%= form.label :description, class: "form-label" %>
                  <%= form.text_area :description, class: "form-control", rows: 3, placeholder: "Bonus description..." %>
                </div>

                <div class="mb-3">
                  <%= form.label :event, class: "form-label" %>
                  <%= form.select :event, event_type_options, 
                      { selected: @event_type }, 
                      { class: "form-select", required: true, 
                        data: { action: "change->bonus_template#toggleTypeSpecificFields" } } %>
                </div>

                <div class="mb-3">
                  <%= form.label :status, class: "form-label" %>
                  <%= form.select :status, status_options, 
                      { selected: 'draft' }, 
                      { class: "form-select", required: true } %>
                </div>

                <div class="mb-3">
                  <%= form.label :project, class: "form-label" %>
                  <%= form.select :project, project_options, 
                      { include_blank: "Select project" }, 
                      { class: "form-select", data: { "bonus-template-target": "project" } } %>
                </div>

                <div class="mb-3">
                  <%= form.label :dsl_tag_id, "DSL Tag", class: "form-label" %>
                  <%= form.select :dsl_tag_id, dsl_tag_options, {}, { class: "form-select max-h-60 overflow-y-auto", data: { "bonus-template-target": "dslTag" } } %>
                </div>

                <div class="mb-3">
                  <%= form.label :currencies, "Currencies", class: "form-label" %>
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted">Select currencies for the bonus</small>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="uncheck-all-currencies-btn" 
                            data-action="click->currency#uncheckAll">
                      <i class="bi bi-check2-all"></i> Uncheck all
                    </button>

                  </div>
                  <div class="currencies-checkboxes border rounded p-3" style="max-height: 150px; overflow-y: auto;">
                    <% selected_currencies = @bonus.currencies.present? ? @bonus.currencies : Bonus.all_currencies %>
                    <% Bonus.all_currencies.each_with_index do |currency, index| %>
                      <div class="form-check <%= 'mb-1' unless index == Bonus.all_currencies.length - 1 %>">
                        <%= check_box_tag "bonus[currencies][]", currency, 
                            selected_currencies.include?(currency),
                            {
                              class: "form-check-input currency-checkbox",
                              id: "currency_#{currency}",
                              data: { 
                                currency: currency,
                                "currency-target": "checkbox"
                              }
                            } %>
                        <%= label_tag "currency_#{currency}", currency, class: "form-check-label" %>
                      </div>
                    <% end %>
                  </div>
                </div>

                <div class="mb-3">
                  <%= form.label :groups, "Target Groups", class: "form-label" %>
                  <%= form.text_field :groups, class: "form-control", 
                      value: @bonus.groups.is_a?(Array) ? @bonus.groups.join(', ') : @bonus.groups %>

                </div>

                <div class="mb-3">
                  <%= form.label :no_more, "Usage Limitation", class: "form-label" %>
                  <%= form.text_field :no_more, class: "form-control", 
                      value: @bonus.no_more %>

                </div>

                <div class="mb-3">
                  <%= form.label :totally_no_more, "Total Activation Limit", class: "form-label" %>
                  <%= form.number_field :totally_no_more, class: "form-control", 
                      min: 1, 
                      value: @bonus.totally_no_more %>

                </div>
              </div>
            </div>

            <!-- Currency Minimum Deposits (only for deposit bonuses) -->
            <div id="currency-minimum-deposits-section" style="<%= 'display: none;' unless @bonus.event == 'deposit' %>">
              <%= render "currency_minimum_deposits", form: form, bonus: @bonus %>
            </div>

            <!-- Wagering Information -->
            <div class="card mb-4" id="wagering-information-card">
              <div class="card-header">
                <h5 class="card-title mb-0">Wagering Information</h5>
              </div>
              <div class="card-body">
                <div class="mb-3" id="minimum-deposit-field" style="display: none;">
                  <%= form.label :minimum_deposit, class: "form-label" %>
                  <%= form.number_field :minimum_deposit, step: 0.01, 
                      class: "form-control", min: 0 %>

                </div>

                <div class="mb-3">
                  <%= form.label :wager, class: "form-label" %>
                  <%= form.number_field :wager, step: 0.01, 
                      class: "form-control", min: 0 %>
                </div>

                <div class="mb-3">
                  <%= form.label :maximum_winnings, class: "form-label" %>
                  <div class="row">
                    <div class="col-md-4">
                      <%= form.select :maximum_winnings_type, 
                          options_for_select([
                            ['Multiplier', 'multiplier'],
                            ['Fixed value', 'fixed']
                          ], 'multiplier'), 
                          {}, 
                          { class: "form-select", id: "maximum_winnings_type_select" } %>
                    </div>
                    <div class="col-md-6">
                      <div class="input-group">
                        <%= form.number_field :maximum_winnings, step: 0.01, 
                            class: "form-control", min: 0, id: "maximum_winnings_input" %>
                        <span class="input-group-text" id="maximum_winnings_suffix">x</span>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="mb-3">
                  <%= form.label :wagering_strategy, class: "form-label" %>
                  <%= form.select :wagering_strategy, wagering_strategy_options, 
                      { include_blank: "Select strategy" }, 
                      { class: "form-select" } %>
                </div>
              </div>
            </div>

            <!-- Availability -->
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="card-title mb-0">Availability</h5>
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <%= form.label :availability_start_date, class: "form-label" %>
                  <%= form.datetime_local_field :availability_start_date, 
                      class: "form-control", required: true,
                      value: (@bonus.availability_start_date || Time.current).strftime("%Y-%m-%dT%H:%M") %>
                </div>

                <div class="mb-3">
                  <%= form.label :availability_end_date, class: "form-label" %>
                  <%= form.datetime_local_field :availability_end_date, 
                      class: "form-control", required: true,
                      value: (@bonus.availability_end_date || 1.month.from_now).strftime("%Y-%m-%dT%H:%M") %>
                </div>
              </div>
            </div>

            <!-- Actions -->
            <div class="card">
              <div class="card-body">
                <div class="d-grid gap-2">
                  <%= form.submit "Create Bonus", class: "btn btn-primary" %>
                  <%= link_to "Cancel", bonuses_path, class: "btn btn-outline-secondary" %>
                </div>
              </div>
            </div>
          </div>

          <!-- Правая колонка: Type-Specific Fields -->
          <div class="col-lg-8">
            <!-- Type-Specific Fields -->
            <div id="type-specific-fields">
              <%= render "type_specific_form", form: form, bonus: @bonus %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>














