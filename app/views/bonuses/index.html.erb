<% content_for :title, "Bonus Management" %>

<div class="container-fluid bonuses-page">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1 class="h2">Bonus Management</h1>
          <p class="text-muted mb-0">View, edit, duplicate, and manage your bonuses</p>
        </div>
        <% if can?(:create, Bonus) %>
          <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bonusTypeModal">
            <i class="fas fa-plus"></i> Create New Bonus
          </button>
        <% end %>
      </div>

      <!-- Permanent Bonuses -->
      <%= render 'permanent_bonuses' %>

      <!-- Filters -->
      <div class="card mb-4">
        <div class="card-body">
          <%= form_with url: bonuses_path, method: :get, local: true, class: "row g-3" do |form| %>
            <div class="col-md-3">
              <%= form.select :type, 
                  options_for_select([
                    ['All Types', ''],
                    ['Deposit', 'deposit'],
                    ['Input Coupon', 'input_coupon'],
                    ['Manual', 'manual'],
                    ['Collection', 'collection'],
                    ['Groups Update', 'groups_update'],
                    ['Scheduler', 'scheduler']
                  ], params[:type]), 
                  {}, 
                  { class: "form-select" } %>
            </div>
            <div class="col-md-3">
              <%= form.select :status, 
                  options_for_select([
                    ['All Statuses', ''],
                    ['Active', 'active'],
                    ['Inactive', 'inactive'],
                    ['Expired', 'expired']
                  ], params[:status]), 
                  {}, 
                  { class: "form-select" } %>
            </div>
            <div class="col-md-2">
              <%= form.text_field :search, 
                  placeholder: "Search by name or code", 
                  value: params[:search], 
                  class: "form-control" %>
            </div>
            <div class="col-md-2">
              <%= form.select :project_id, 
                  options_for_select(
                    [['All Projects', '']] + Project.order(:name).map { |p| [p.name, p.id] },
                    params[:project_id]
                  ), 
                  {}, 
                  { class: "form-select" } %>
            </div>
            <div class="col-md-2">
              <%= form.text_field :dsl_tag, 
                  placeholder: "DSL tag", 
                  value: params[:dsl_tag], 
                  class: "form-control" %>
            </div>
            <div class="col-md-3">
              <%= form.submit "Filter", class: "btn btn-outline-secondary" %>
              <%= link_to "Clear", bonuses_path, class: "btn btn-outline-secondary ms-2" %>
            </div>
          <% end %>
          </div>
</div>

<script>
// Enhance duplicate button functionality
document.addEventListener('DOMContentLoaded', function() {
  // Add loading state to duplicate buttons
  const duplicateButtons = document.querySelectorAll('button[data-confirm*="duplicate"]');
  
  duplicateButtons.forEach(button => {
    button.addEventListener('click', function(e) {
      if (confirm(this.getAttribute('data-confirm'))) {
        // Add loading state
        const originalText = this.innerHTML;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        this.disabled = true;
        
        // Re-enable button after a delay (in case of error)
        setTimeout(() => {
          this.innerHTML = originalText;
          this.disabled = false;
        }, 10000); // 10 seconds timeout
      }
    });
  });
  
  // Enhance bulk actions
  const bulkActionSelect = document.querySelector('select[name="bulk_action"]');
  if (bulkActionSelect) {
    bulkActionSelect.addEventListener('change', function() {
      const selectedAction = this.value;
      const submitButton = this.closest('form').querySelector('input[type="submit"]');
      
      if (selectedAction === 'duplicate') {
        submitButton.textContent = 'Duplicate Selected';
        submitButton.className = 'btn btn-outline-secondary';
      } else if (selectedAction === 'delete') {
        submitButton.textContent = 'Delete Selected';
        submitButton.className = 'btn btn-outline-danger';
      } else {
        submitButton.textContent = 'Apply to Selected';
        submitButton.className = 'btn btn-secondary';
      }
    });
  }
});

// Function to submit bulk actions
function submitBulkAction() {
  const bulkAction = document.querySelector('select[name="bulk_action"]').value;
  const selectedBonuses = document.querySelectorAll('input.bonus-checkbox:checked');
  
  if (bulkAction === '') {
    alert('Please select an action');
    return false;
  }
  
  if (selectedBonuses.length === 0) {
    alert('Please select at least one bonus');
    return false;
  }
  
  if (bulkAction === 'duplicate') {
    return confirm(`Are you sure you want to duplicate ${selectedBonuses.length} bonus(es)? New draft bonuses will be created.`);
  } else if (bulkAction === 'delete') {
    return confirm(`Are you sure you want to delete ${selectedBonuses.length} bonus(es)? This action cannot be undone.`);
  }
  
  return true;
}
</script>

      <!-- Bonuses Table -->
      <div class="card">
        <div class="card-body">
          <% if @bonuses.any? %>
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead class="table-dark">
                  <tr>
                    <th><input type="checkbox" id="select-all"></th>
                    <th class="text-start">ID</th>
                    <th>Name</th>
                    <th>Code</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Project</th>
                    <th>DSL Tag</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% @bonuses.each do |bonus| %>
                    <tr>
                      <td>
                        <input type="checkbox" class="bonus-checkbox" value="<%= bonus.id %>">
                      </td>
                      <td class="text-start">
                        <div><%= bonus.id %></div>
                      </td>
                      <td class="text-start">
                        <%= link_to bonus.name, bonus_path(bonus), class: "text-decoration-none" %>
                        <% if @permanent_bonus_ids.include?(bonus.id) %>
                          <span class="badge bg-warning text-dark ms-2" title="Permanent bonus for <%= @current_project&.name %>">
                            <i class="fas fa-star"></i> Permanent
                          </span>
                        <% end %>
                        <% if bonus.description.present? %>
                          <div class="small text-muted mt-1" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="<%= h(bonus.description) %>">
                            <%= truncate(bonus.description, length: 50) %>
                          </div>
                        <% end %>
                      </td>
                      <td>
                        <code class="text-dark"><%= bonus.display_code %></code>
                      </td>
                      <td>
                        <span class="badge bg-secondary text-white">
                          <%= bonus.event.humanize %>
                        </span>
                      </td>
                      <td>
                        <span class="badge <%= status_badge_class(bonus.status) %>">
                          <%= bonus.status.humanize %>
                        </span>
                      </td>
                      <td>
                        <% if bonus.project.present? %>
                          <span class="badge bg-primary"><%= bonus.project %></span>
                        <% else %>
                          <span class="text-muted">-</span>
                        <% end %>
                      </td>
                      <td>
                        <% if bonus.dsl_tag.present? %>
                          <code class="text-dark"><%= bonus.dsl_tag %></code>
                        <% else %>
                          <span class="text-muted">-</span>
                        <% end %>
                      </td>
                      <td><%= bonus.availability_start_date.strftime("%Y-%m-%d") %></td>
                      <td><%= bonus.availability_end_date.strftime("%Y-%m-%d") %></td>
                      <td>
                        <div class="btn-group btn-group-sm" role="group">
                          <%= link_to bonus_path(bonus), class: "btn btn-outline-info" do %>
                            <i class="fas fa-eye"></i>
                          <% end %>
                          <% if can?(:update, bonus) %>
                            <%= link_to edit_bonus_path(bonus), class: "btn btn-outline-primary" do %>
                              <i class="fas fa-edit"></i>
                            <% end %>
                          <% end %>
                          <% if can?(:create, Bonus) %>
                            <%= link_to duplicate_bonus_path(bonus),
                                class: "btn btn-outline-secondary",
                                data: { "turbo-method": :post, confirm: "Are you sure you want to duplicate this bonus? A new draft bonus will be created." },
                                title: "Duplicate" do %>
                              <i class="fas fa-copy"></i>
                            <% end %>
                          <% end %>
                          <% if can?(:destroy, bonus) %>
                            <%= link_to bonus_path(bonus), 
                                class: "btn btn-outline-danger", 
                                data: { "turbo-method": :delete, confirm: "Are you sure?" } do %>
                              <i class="fas fa-trash"></i>
                            <% end %>
                          <% end %>
                        </div>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>

            <!-- Bulk Actions -->
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div>
                <small class="text-muted d-block mb-2">Select multiple bonuses and apply bulk actions</small>
                <%= form_with url: bulk_update_bonuses_path, method: :post, local: true, 
                    class: "d-flex align-items-center" do |form| %>
                  <%= form.select :bulk_action, 
                      options_for_select([
                        ['Select Action', ''],
                        ['Duplicate', 'duplicate'],
                        ['Delete', 'delete']
                      ]), 
                      {}, 
                      { class: "form-select me-2", style: "width: auto;" } %>
                  <%= form.submit "Apply to Selected", class: "btn btn-secondary", 
                      onclick: "return submitBulkAction()" %>
                <% end %>
              </div>
              
              <!-- Enhanced Pagination -->
              <div>
                <% current_page = (params[:page] || 1).to_i %>
                <% if current_page > 1 %>
                  <%= link_to "Previous", bonuses_path(params.permit(:type, :status, :search, :project, :project_id, :dsl_tag).merge(page: current_page - 1)), 
                      class: "btn btn-outline-secondary me-2" %>
                <% end %>
                
                <span class="me-2">
                  Page <%= current_page %> of <%= @total_pages %>
                <span>
                
                <% if current_page < @total_pages %>
                  <%= link_to "Next", bonuses_path(params.permit(:type, :status, :search, :project, :project_id, :dsl_tag).merge(page: current_page + 1)), 
                      class: "btn btn-outline-secondary" %>
                <% end %>
              </div>
            </div>
          <% else %>
            <div class="text-center py-5">
              <h4>No bonuses found</h4>
              <p class="text-muted">Create your first bonus to get started.</p>
              <%= link_to "Create Bonus", new_bonus_path, class: "btn btn-primary" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Select all checkboxes
  document.getElementById('select-all').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.bonus-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = this.checked);
  });

  // Bulk action submission
  function submitBulkAction() {
    const selectedIds = Array.from(document.querySelectorAll('.bonus-checkbox:checked'))
                             .map(cb => cb.value);
    
    if (selectedIds.length === 0) {
      alert('Please select at least one bonus.');
      return false;
    }

    const action = document.querySelector('select[name="bulk_action"]').value;
    if (!action) {
      alert('Please select an action.');
      return false;
    }

    if (action === 'delete' && !confirm('Are you sure you want to delete the selected bonuses?')) {
      return false;
    }

    // Add selected IDs to form
    selectedIds.forEach(id => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'bonus_ids[]';
      input.value = id;
      event.target.form.appendChild(input);
    });

    return true;
  }
</script>

<!-- Modal for Bonus Type Selection -->
<div class="modal fade" id="bonusTypeModal" tabindex="-1" aria-labelledby="bonusTypeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bonusTypeModalLabel">
          <i class="fas fa-plus-circle"></i> Create New Bonus
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-4">Select the type of bonus you want to create:</p>
        
        <div class="row g-3">
          <div class="col-md-6">
            <div class="card h-100 bonus-type-card" data-type="deposit">
              <div class="card-body d-flex flex-column">
                <div class="text-center mb-3">
                  <i class="fas fa-coins fa-3x text-success"></i>
                </div>
                <h5 class="card-title text-center">Deposit Bonus</h5>
                <p class="card-text text-muted small flex-grow-1">
                  Bonuses that require a minimum deposit amount. Users get bonus funds based on their deposit percentage.
                </p>
                <div class="text-center">
                  <%= link_to "Create Deposit Bonus", new_bonus_path(event: 'deposit'), 
                      class: "btn btn-success btn-sm" %>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="card h-100 bonus-type-card" data-type="input_coupon">
              <div class="card-body d-flex flex-column">
                <div class="text-center mb-3">
                  <i class="fas fa-ticket-alt fa-3x text-primary"></i>
                </div>
                <h5 class="card-title text-center">Coupon Bonus</h5>
                <p class="card-text text-muted small flex-grow-1">
                  Bonuses activated by entering a coupon code. No deposit required, just enter the valid code.
                </p>
                <div class="text-center">
                  <%= link_to "Create Coupon Bonus", new_bonus_path(event: 'input_coupon'), 
                      class: "btn btn-primary btn-sm" %>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="card h-100 bonus-type-card" data-type="manual">
              <div class="card-body d-flex flex-column">
                <div class="text-center mb-3">
                  <i class="fas fa-user-cog fa-3x text-warning"></i>
                </div>
                <h5 class="card-title text-center">Manual Bonus</h5>
                <p class="card-text text-muted small flex-grow-1">
                  Bonuses that require manual approval or are applied manually by administrators.
                </p>
                <div class="text-center">
                  <%= link_to "Create Manual Bonus", new_bonus_path(event: 'manual'), 
                      class: "btn btn-warning btn-sm" %>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="card h-100 bonus-type-card" data-type="collection">
              <div class="card-body d-flex flex-column">
                <div class="text-center mb-3">
                  <i class="fas fa-gift fa-3x text-info"></i>
                </div>
                <h5 class="card-title text-center">Collection Bonus</h5>
                <p class="card-text text-muted small flex-grow-1">
                  Daily, weekly, or monthly collectible bonuses that users can claim periodically.
                </p>
                <div class="text-center">
                  <%= link_to "Create Collection Bonus", new_bonus_path(event: 'collection'), 
                      class: "btn btn-info btn-sm" %>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="card h-100 bonus-type-card" data-type="groups_update">
              <div class="card-body d-flex flex-column">
                <div class="text-center mb-3">
                  <i class="fas fa-users fa-3x text-secondary"></i>
                </div>
                <h5 class="card-title text-center">Groups Update Bonus</h5>
                <p class="card-text text-muted small flex-grow-1">
                  Bonuses that update multiple user groups at once with batch processing capabilities.
                </p>
                <div class="text-center">
                  <%= link_to "Create Groups Update Bonus", new_bonus_path(event: 'groups_update'), 
                      class: "btn btn-secondary btn-sm" %>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="card h-100 bonus-type-card" data-type="scheduler">
              <div class="card-body d-flex flex-column">
                <div class="text-center mb-3">
                  <i class="fas fa-clock fa-3x text-dark"></i>
                </div>
                <h5 class="card-title text-center">Scheduler Bonus</h5>
                <p class="card-text text-muted small flex-grow-1">
                  Time-based bonuses that are automatically triggered according to a schedule or cron expression.
                </p>
                <div class="text-center">
                  <%= link_to "Create Scheduler Bonus", new_bonus_path(event: 'scheduler'), 
                      class: "btn btn-dark btn-sm" %>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<style>
  .bonus-type-card {
    transition: transform 0.2s ease-in-out;
    cursor: pointer;
  }
  
  .bonus-type-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  /* Ensure consistent text color for code elements */
  code.text-dark {
    color: #212529 !important;
    background-color: #f8f9fa;
    padding: 2px 4px;
    border-radius: 3px;
    font-size: 0.875em;
  }
  
  /* Improve button group styling */
  .bonuses-page .btn-group-sm .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 32px !important;
    height: 32px !important;
    min-width: 32px !important;
    min-height: 32px !important;
    padding: 0 !important;
    line-height: 1;
    font-size: 0.875rem;
    border-radius: 0.2rem;
  }
  
  /* Add hover effects for action buttons */
  .btn-group-sm .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.2s ease;
  }
  
  /* Style for duplicate button specifically */
  .btn-outline-secondary:hover {
    background-color: #6c757d;
    border-color: #6c757d;
    color: white;
  }
  
  /* Loading state for duplicate buttons */
  .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  
  /* Tooltip enhancement */
  .btn[title] {
    position: relative;
  }
  
  /* Responsive button group */
  @media (max-width: 768px) {
    .btn-group-sm {
      display: flex;
      flex-direction: column;
    }
    
    .btn-group-sm .btn {
      border-radius: 0.2rem !important;
      margin-bottom: 0.25rem;
    }
  }

  /* Simple modal backdrop fix */
  .modal-backdrop {
    background-color: rgba(0, 0, 0, 0.5) !important;
  }
</style>

<script>
  // Simple modal backdrop fix
  document.addEventListener('DOMContentLoaded', function() {
    const bonusTypeModal = document.getElementById('bonusTypeModal');
    if (bonusTypeModal) {
      bonusTypeModal.addEventListener('show.bs.modal', function() {
        setTimeout(() => {
          const backdrop = document.querySelector('.modal-backdrop');
          if (backdrop) {
            backdrop.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
          }
        }, 10);
      });
    }
  });
</script>
