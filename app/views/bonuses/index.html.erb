<% content_for :title, "Bonus Management" %>

<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">Bonus Management</h1>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bonusTypeModal">
          <i class="fas fa-plus"></i> Create New Bonus
        </button>
      </div>

      <!-- Filters -->
      <div class="card mb-4">
        <div class="card-body">
          <%= form_with url: bonuses_path, method: :get, local: true, class: "row g-3" do |form| %>
            <div class="col-md-3">
              <%= form.select :type, 
                  options_for_select([
                    ['All Types', ''],
                    ['Deposit', 'deposit'],
                    ['Input Coupon', 'input_coupon'],
                    ['Manual', 'manual'],
                    ['Collection', 'collection'],
                    ['Groups Update', 'groups_update'],
                    ['Scheduler', 'scheduler']
                  ], params[:type]), 
                  {}, 
                  { class: "form-select" } %>
            </div>
            <div class="col-md-3">
              <%= form.select :status, 
                  options_for_select([
                    ['All Statuses', ''],
                    ['Active', 'active'],
                    ['Inactive', 'inactive'],
                    ['Expired', 'expired']
                  ], params[:status]), 
                  {}, 
                  { class: "form-select" } %>
            </div>
            <div class="col-md-2">
              <%= form.text_field :search, 
                  placeholder: "Search by name or code", 
                  value: params[:search], 
                  class: "form-control" %>
            </div>
            <div class="col-md-2">
              <%= form.select :project, 
                  options_for_select([
                    ['All Projects', ''],
                    ['VOLNA', 'VOLNA'],
                    ['ROX', 'ROX'],
                    ['FRESH', 'FRESH'],
                    ['SOL', 'SOL'],
                    ['JET', 'JET'],
                    ['IZZI', 'IZZI'],
                    ['LEGZO', 'LEGZO'],
                    ['STARDA', 'STARDA'],
                    ['DRIP', 'DRIP'],
                    ['MONRO', 'MONRO'],
                    ['1GO', '1GO'],
                    ['LEX', 'LEX'],
                    ['GIZBO', 'GIZBO'],
                    ['IRWIN', 'IRWIN'],
                    ['FLAGMAN', 'FLAGMAN'],
                    ['MARTIN', 'MARTIN'],
                    ['P17', 'P17'],
                    ['ANJUAN', 'ANJUAN'],
                    ['NAMASTE', 'NAMASTE']
                  ], params[:project]), 
                  {}, 
                  { class: "form-select" } %>
            </div>
            <div class="col-md-2">
              <%= form.text_field :dsl_tag, 
                  placeholder: "DSL tag", 
                  value: params[:dsl_tag], 
                  class: "form-control" %>
            </div>
            <div class="col-md-3">
              <%= form.submit "Filter", class: "btn btn-outline-secondary" %>
              <%= link_to "Clear", bonuses_path, class: "btn btn-outline-secondary ms-2" %>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Bonuses Table -->
      <div class="card">
        <div class="card-body">
          <% if @bonuses.any? %>
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead class="table-dark">
                  <tr>
                    <th><input type="checkbox" id="select-all"></th>
                    <th>Name</th>
                    <th>Code</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Project</th>
                    <th>DSL Tag</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <% @bonuses.each do |bonus| %>
                    <tr>
                      <td>
                        <input type="checkbox" class="bonus-checkbox" value="<%= bonus.id %>">
                      </td>
                      <td>
                        <%= link_to bonus.name, bonus_path(bonus), class: "text-decoration-none" %>
                      </td>
                      <td>
                        <code><%= bonus.code %></code>
                      </td>
                      <td>
                        <span class="badge bg-info text-dark">
                          <%= bonus.bonus_type.humanize %>
                        </span>
                      </td>
                      <td>
                        <span class="badge <%= status_badge_class(bonus.status) %>">
                          <%= bonus.status.humanize %>
                        </span>
                      </td>
                      <td>
                        <% if bonus.project.present? %>
                          <span class="badge bg-primary"><%= bonus.project %></span>
                        <% else %>
                          <span class="text-muted">-</span>
                        <% end %>
                      </td>
                      <td>
                        <% if bonus.dsl_tag.present? %>
                          <code><%= bonus.dsl_tag %></code>
                        <% else %>
                          <span class="text-muted">-</span>
                        <% end %>
                      </td>
                      <td><%= bonus.availability_start_date.strftime("%Y-%m-%d") %></td>
                      <td><%= bonus.availability_end_date.strftime("%Y-%m-%d") %></td>
                      <td>
                        <div class="btn-group btn-group-sm" role="group">
                          <%= link_to bonus_path(bonus), class: "btn btn-outline-info" do %>
                            <i class="fas fa-eye"></i>
                          <% end %>
                          <%= link_to edit_bonus_path(bonus), class: "btn btn-outline-primary" do %>
                            <i class="fas fa-edit"></i>
                          <% end %>
                          <%= link_to bonus_path(bonus), 
                              class: "btn btn-outline-danger", 
                              data: { "turbo-method": :delete, confirm: "Are you sure?" } do %>
                            <i class="fas fa-trash"></i>
                          <% end %>
                        </div>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>

            <!-- Bulk Actions -->
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div>
                <%= form_with url: bulk_update_bonuses_path, method: :post, local: true, 
                    class: "d-flex align-items-center" do |form| %>
                  <%= form.select :bulk_action, 
                      options_for_select([
                        ['Select Action', ''],
                        ['Delete', 'delete']
                      ]), 
                      {}, 
                      { class: "form-select me-2", style: "width: auto;" } %>
                  <%= form.submit "Apply to Selected", class: "btn btn-secondary", 
                      onclick: "return submitBulkAction()" %>
                <% end %>
              </div>
              
              <!-- Simple Pagination -->
              <div>
                <% current_page = (params[:page] || 1).to_i %>
                <% if current_page > 1 %>
                  <%= link_to "Previous", bonuses_path(params.permit(:type, :status, :search, :country).merge(page: current_page - 1)), 
                      class: "btn btn-outline-secondary me-2" %>
                <% end %>
                <span class="me-2">Page <%= current_page %></span>
                <%= link_to "Next", bonuses_path(params.permit(:type, :status, :search, :country).merge(page: current_page + 1)), 
                    class: "btn btn-outline-secondary" %>
              </div>
            </div>
          <% else %>
            <div class="text-center py-5">
              <h4>No bonuses found</h4>
              <p class="text-muted">Create your first bonus to get started.</p>
              <%= link_to "Create Bonus", new_bonus_path, class: "btn btn-primary" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Select all checkboxes
  document.getElementById('select-all').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.bonus-checkbox');
    checkboxes.forEach(checkbox => checkbox.checked = this.checked);
  });

  // Bulk action submission
  function submitBulkAction() {
    const selectedIds = Array.from(document.querySelectorAll('.bonus-checkbox:checked'))
                             .map(cb => cb.value);
    
    if (selectedIds.length === 0) {
      alert('Please select at least one bonus.');
      return false;
    }

    const action = document.querySelector('select[name="bulk_action"]').value;
    if (!action) {
      alert('Please select an action.');
      return false;
    }

    if (action === 'delete' && !confirm('Are you sure you want to delete the selected bonuses?')) {
      return false;
    }

    // Add selected IDs to form
    selectedIds.forEach(id => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'bonus_ids[]';
      input.value = id;
      event.target.form.appendChild(input);
    });

    return true;
  }
</script>

<!-- Modal for Bonus Type Selection -->
<div class="modal fade" id="bonusTypeModal" tabindex="-1" aria-labelledby="bonusTypeModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bonusTypeModalLabel">
          <i class="fas fa-plus-circle"></i> Create New Bonus
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p class="text-muted mb-4">Select the type of bonus you want to create:</p>
        
        <div class="row g-3">
          <div class="col-md-6">
            <div class="card h-100 bonus-type-card" data-type="deposit">
              <div class="card-body d-flex flex-column">
                <div class="text-center mb-3">
                  <i class="fas fa-coins fa-3x text-success"></i>
                </div>
                <h5 class="card-title text-center">Deposit Bonus</h5>
                <p class="card-text text-muted small flex-grow-1">
                  Bonuses that require a minimum deposit amount. Users get bonus funds based on their deposit percentage.
                </p>
                <div class="text-center">
                  <%= link_to "Create Deposit Bonus", new_bonus_path(type: 'deposit'), 
                      class: "btn btn-success btn-sm" %>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="card h-100 bonus-type-card" data-type="input_coupon">
              <div class="card-body d-flex flex-column">
                <div class="text-center mb-3">
                  <i class="fas fa-ticket-alt fa-3x text-primary"></i>
                </div>
                <h5 class="card-title text-center">Coupon Bonus</h5>
                <p class="card-text text-muted small flex-grow-1">
                  Bonuses activated by entering a coupon code. No deposit required, just enter the valid code.
                </p>
                <div class="text-center">
                  <%= link_to "Create Coupon Bonus", new_bonus_path(type: 'input_coupon'), 
                      class: "btn btn-primary btn-sm" %>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="card h-100 bonus-type-card" data-type="manual">
              <div class="card-body d-flex flex-column">
                <div class="text-center mb-3">
                  <i class="fas fa-user-cog fa-3x text-warning"></i>
                </div>
                <h5 class="card-title text-center">Manual Bonus</h5>
                <p class="card-text text-muted small flex-grow-1">
                  Bonuses that require manual approval or are applied manually by administrators.
                </p>
                <div class="text-center">
                  <%= link_to "Create Manual Bonus", new_bonus_path(type: 'manual'), 
                      class: "btn btn-warning btn-sm" %>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="card h-100 bonus-type-card" data-type="collection">
              <div class="card-body d-flex flex-column">
                <div class="text-center mb-3">
                  <i class="fas fa-gift fa-3x text-info"></i>
                </div>
                <h5 class="card-title text-center">Collection Bonus</h5>
                <p class="card-text text-muted small flex-grow-1">
                  Daily, weekly, or monthly collectible bonuses that users can claim periodically.
                </p>
                <div class="text-center">
                  <%= link_to "Create Collection Bonus", new_bonus_path(type: 'collection'), 
                      class: "btn btn-info btn-sm" %>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="card h-100 bonus-type-card" data-type="groups_update">
              <div class="card-body d-flex flex-column">
                <div class="text-center mb-3">
                  <i class="fas fa-users fa-3x text-secondary"></i>
                </div>
                <h5 class="card-title text-center">Groups Update Bonus</h5>
                <p class="card-text text-muted small flex-grow-1">
                  Bonuses that update multiple user groups at once with batch processing capabilities.
                </p>
                <div class="text-center">
                  <%= link_to "Create Groups Update Bonus", new_bonus_path(type: 'groups_update'), 
                      class: "btn btn-secondary btn-sm" %>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="card h-100 bonus-type-card" data-type="scheduler">
              <div class="card-body d-flex flex-column">
                <div class="text-center mb-3">
                  <i class="fas fa-clock fa-3x text-dark"></i>
                </div>
                <h5 class="card-title text-center">Scheduler Bonus</h5>
                <p class="card-text text-muted small flex-grow-1">
                  Time-based bonuses that are automatically triggered according to a schedule or cron expression.
                </p>
                <div class="text-center">
                  <%= link_to "Create Scheduler Bonus", new_bonus_path(type: 'scheduler'), 
                      class: "btn btn-dark btn-sm" %>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<style>
  .bonus-type-card {
    transition: transform 0.2s ease-in-out;
    cursor: pointer;
  }
  
  .bonus-type-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
</style>
