<!-- Currency Minimum Deposits Section -->
<div class="card mb-4" id="currency-minimum-deposits-card">
  <div class="card-header">
    <h5 class="card-title mb-0">
      <i class="bi bi-currency-exchange"></i> 
      Minimum deposits by currency
    </h5>
  </div>
  <div class="card-body">
    <div id="currency-minimum-deposits-container">
      <div class="row">
        <% available_currencies = bonus.project_currencies %>
        <% selected_currencies = bonus.currencies.present? ? (bonus.currencies & available_currencies) : available_currencies %>
        
        <% selected_currencies.each_with_index do |currency, index| %>
          <div class="col-12 mb-2">
            <div class="input-group">
              <span class="input-group-text"><%= currency %></span>
              <%= number_field_tag "bonus[currency_minimum_deposits][#{currency}]", 
                  bonus.currency_minimum_deposits[currency],
                  class: "form-control currency-input",
                  step: Bonus.currency_step(currency),
                  min: 0,
                  placeholder: (Bonus.crypto_currency?(currency) ? "0.00000000" : "0.00"),
                  data: { 
                    currency: currency, 
                    precision: Bonus.currency_precision(currency),
                    "currency-validation-target": "input",
                    "currency-target": "minimumDeposit"
                  } %>
            </div>
          </div>
        <% end %>
      </div>

    </div>
    
    <!-- Dynamic update based on selected currencies -->
    <script>
      // Helper function to get selected currencies from checkboxes
      function getSelectedCurrenciesMinimumDeposits() {
        const checkboxes = document.querySelectorAll('input.currency-checkbox:checked');
        return Array.from(checkboxes).map(checkbox => checkbox.value);
      }

      // Function to update currency minimum deposits fields based on selected currencies
      window.updateCurrencyMinimumDepositsFields = function() {
        const container = document.getElementById('currency-minimum-deposits-container');
        if (!container) return;
        
        const selectedCurrencies = getSelectedCurrenciesMinimumDeposits();
        const availableCurrencies = window.currentProjectCurrencies || [];
        const cryptoCurrencies = window.currentProjectCryptoCurrencies || [];
        
        // If no currencies selected, show all available currencies for the project
        const displayCurrencies = selectedCurrencies.length > 0 ? selectedCurrencies : availableCurrencies;
        
        // Check if update is actually needed by comparing current displayed currencies
        const rowDiv = container.querySelector('.row');
        if (rowDiv) {
          const currentCurrencies = Array.from(rowDiv.querySelectorAll('input[type="number"]'))
            .map(input => {
              const match = input.name.match(/currency_minimum_deposits\[([^\]]+)\]/);
              return match ? match[1] : null;
            })
            .filter(currency => currency !== null);
          
          // If currencies are the same, don't rebuild
          if (currentCurrencies.length === displayCurrencies.length && 
              currentCurrencies.every(currency => displayCurrencies.includes(currency))) {
            return; // No update needed
          }
        }
        
        // Rebuild the fields
        const rowDiv = container.querySelector('.row');
        if (!rowDiv) return;
        
        // Save ALL current values to preserve user input
        const currentValues = {};
        rowDiv.querySelectorAll('input[type="number"]').forEach(input => {
          const match = input.name.match(/currency_minimum_deposits\[([^\]]+)\]/);
          if (match) {
            // Save value even if it's being edited or just typed
            const value = input.value || input.getAttribute('value') || '';
            if (value) {
              currentValues[match[1]] = value;
            }
          }
        });
        
        // Clear and rebuild
        rowDiv.innerHTML = '';
        
        displayCurrencies.forEach(currency => {
          const colDiv = document.createElement('div');
          colDiv.className = 'col-12 mb-2';
          
          const isCrypto = cryptoCurrencies.includes(currency);
          const step = isCrypto ? '0.00000001' : '0.01';
          const placeholder = isCrypto ? '0.00000000' : '0.00';
          const precision = isCrypto ? 8 : 2;
          
          // Only use current value if currency is still selected
          // Always use current value if it exists to preserve user input
          const currentValue = currentValues[currency] || '';
          
          colDiv.innerHTML = `
            <div class="input-group">
              <span class="input-group-text">${currency}</span>
              <input type="number" 
                     name="bonus[currency_minimum_deposits][${currency}]" 
                     value="${currentValue}"
                     class="form-control currency-input" 
                     step="${step}" 
                     min="0"
                     placeholder="${placeholder}"
                     data-currency="${currency}"
                     data-precision="${precision}"
                     data-currency-validation-target="input"
                     data-currency-target="minimumDeposit">
            </div>
          `;
          
          rowDiv.appendChild(colDiv);
        });

      };
      
      // Note: Event listeners for currency checkboxes are handled globally
    </script>
  </div>
</div>
