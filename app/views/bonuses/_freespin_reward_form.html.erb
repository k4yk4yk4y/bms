<%
  # Set defaults for parameters
  reward ||= nil
  index ||= 0
  
  # Get existing freespin reward for editing
  existing_freespin = reward || (@bonus&.freespin_rewards&.first if @bonus&.persisted?)
  
  # Field name prefix for indexed parameters
  field_prefix = "freespin_rewards[#{index}]"
%>

<div class="card mb-3" id="freespin-reward-<%= index %>">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h6 class="mb-0">Freespin Reward #<%= index + 1 %></h6>
    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFreespinReward(<%= index %>)">
      <i class="fas fa-trash"></i> Remove
    </button>
  </div>
  <div class="card-body">



<!-- Основные часто используемые параметры для freespins -->
<div class="main-params-container">
  <h6 class="text-success reward-section-header full-width">Основные параметры</h6>

  <!-- Games -->
  <div class="reward-param-field full-width">
    <label for="freespin_reward_games_<%= index %>" class="form-label">Игры (games)</label>
    <input type="text" class="form-control" name="<%= field_prefix %>[games]" id="freespin_reward_games_<%= index %>"
            value="<%= existing_freespin&.games&.join(', ') %>">
  </div>

  <!-- Freespins Count -->
  <div class="reward-param-field">
    <label for="freespin_reward_spins_count_<%= index %>" class="form-label">Количество фриспинов</label>
    <input type="number" class="form-control" name="<%= field_prefix %>[spins_count]" id="freespin_reward_spins_count_<%= index %>"
           min="1" required  value="<%= existing_freespin&.spins_count %>">
  </div>

  <!-- Bet Level -->
  <div class="reward-param-field">
    <label for="freespin_reward_bet_level_<%= index %>" class="form-label">Уровень ставки (bet_level)</label>
    <div class="input-group">
      <input type="number" class="form-control" name="<%= field_prefix %>[bet_level]" id="freespin_reward_bet_level_<%= index %>"
             step="0.01" min="0"  value="<%= existing_freespin&.bet_level %>">
      <span class="input-group-text">€</span>
    </div>
  </div>





</div>

<!-- Currency Freespin Bet Levels - в отдельной секции -->
<div class="currency-bet-levels-section mt-3">
  <%
    # Определяем валюты для freespin reward
    freespin_currencies = []
    if @bonus.currency_minimum_deposits.present? && @bonus.currency_minimum_deposits.any?
      freespin_currencies = @bonus.currency_minimum_deposits.keys
    elsif @bonus.currencies.present? && @bonus.currencies.any?
      freespin_currencies = @bonus.currencies
    end
  %>
  <%= render "currency_freespin_bet_levels", bonus: @bonus, existing_freespin: existing_freespin, currencies: freespin_currencies %>
</div>

<!-- Дополнительные параметры -->
<div class="mt-4">
  <button type="button" class="btn btn-outline-secondary btn-sm" id="toggle_freespin_advanced" 
          onclick="toggleAdvancedFreespinParams()">
    <i class="fas fa-plus"></i> Показать дополнительные параметры
  </button>
  
  <div class="advanced-params mt-3" style="display: none;">
    <div class="card">
      <div class="card-header">
        <h6 class="card-title mb-0">Дополнительные параметры</h6>
      </div>
      <div class="card-body">
        <div class="advanced-params-container">
          <div class="reward-param-field">
            <label for="freespin_reward_auto_activate_<%= index %>" class="form-label">Автоактивация</label>
            <select class="form-select" name="<%= field_prefix %>[auto_activate]" id="freespin_reward_auto_activate_<%= index %>">
              <option value="">Не задано</option>
              <option value="true" <%= 'selected' if existing_freespin&.get_advanced_param('auto_activate') == true %>>Да</option>
              <option value="false" <%= 'selected' if existing_freespin&.get_advanced_param('auto_activate') == false %>>Нет</option>
            </select>
          </div>

          <div class="reward-param-field">
            <label for="freespin_reward_duration_<%= index %>" class="form-label">Длительность</label>
            <input type="text" class="form-control" name="<%= field_prefix %>[duration]"
                   id="freespin_reward_duration_<%= index %>"
                   value="<%= existing_freespin&.get_advanced_param('duration') %>">
          </div>

          <div class="reward-param-field">
            <label for="freespin_reward_activation_duration_<%= index %>" class="form-label">Время активации</label>
            <input type="text" class="form-control" name="<%= field_prefix %>[activation_duration]"
                   id="freespin_reward_activation_duration_<%= index %>"
                   value="<%= existing_freespin&.get_advanced_param('activation_duration') %>">
          </div>

          <div class="reward-param-field">
            <label for="freespin_reward_email_template_<%= index %>" class="form-label">Email шаблон</label>
            <input type="text" class="form-control" name="<%= field_prefix %>[email_template]"
                   id="freespin_reward_email_template_<%= index %>"
                   value="<%= existing_freespin&.get_advanced_param('email_template') %>">
          </div>

          <div class="reward-param-field">
            <label for="freespin_reward_range_<%= index %>" class="form-label">Диапазон (range)</label>
            <input type="text" class="form-control" name="<%= field_prefix %>[range]"
                   id="freespin_reward_range_<%= index %>"
                   value="<%= existing_freespin&.get_advanced_param('range') %>">
          </div>

          <div class="reward-param-field full-width">
            <label for="freespin_reward_last_login_country_<%= index %>" class="form-label">Страна последнего входа</label>
            <input type="text" class="form-control" name="<%= field_prefix %>[last_login_country]"
                   id="freespin_reward_last_login_country_<%= index %>"
                   value="<%= existing_freespin&.get_advanced_param('last_login_country') %>">
          </div>

          <div class="reward-param-field full-width">
            <label for="freespin_reward_profile_country_<%= index %>" class="form-label">Страна профиля</label>
            <input type="text" class="form-control" name="<%= field_prefix %>[profile_country]"
                   id="freespin_reward_profile_country_<%= index %>"
                   value="<%= existing_freespin&.get_advanced_param('profile_country') %>">
          </div>

          <div class="reward-param-field full-width">
            <label for="freespin_reward_current_ip_country_<%= index %>" class="form-label">Страна текущего IP</label>
            <input type="text" class="form-control" name="<%= field_prefix %>[current_ip_country]"
                   id="freespin_reward_current_ip_country_<%= index %>"
                   value="<%= existing_freespin&.get_advanced_param('current_ip_country') %>">
          </div>

          <div class="reward-param-field full-width">
            <label for="freespin_reward_emails_<%= index %>" class="form-label">Email адреса</label>
            <input type="text" class="form-control" name="<%= field_prefix %>[emails]"
                   id="freespin_reward_emails_<%= index %>"
                   value="<%= existing_freespin&.get_advanced_param('emails') %>">
          </div>

          <div class="reward-param-field full-width">
            <label for="freespin_reward_deposit_payment_systems_<%= index %>" class="form-label">Платежные системы депозита</label>
            <input type="text" class="form-control" name="<%= field_prefix %>[deposit_payment_systems]"
                   id="freespin_reward_deposit_payment_systems_<%= index %>"
                   value="<%= existing_freespin&.get_advanced_param('deposit_payment_systems') %>">
          </div>

          <div class="reward-param-field full-width">
            <label for="freespin_reward_cashout_payment_systems_<%= index %>" class="form-label">Платежные системы вывода</label>
            <input type="text" class="form-control" name="<%= field_prefix %>[cashout_payment_systems]"
                   id="freespin_reward_cashout_payment_systems_<%= index %>"
                   value="<%= existing_freespin&.get_advanced_param('cashout_payment_systems') %>">
          </div>

          <div class="reward-param-field">
            <label for="freespin_reward_user_can_have_duplicates_<%= index %>" class="form-label">Пользователь может иметь дубликаты</label>
            <select class="form-select" name="<%= field_prefix %>[user_can_have_duplicates]" id="freespin_reward_user_can_have_duplicates_<%= index %>">
              <option value="">Не задано</option>
              <option value="true" <%= 'selected' if existing_freespin&.get_advanced_param('user_can_have_duplicates') == true %>>Да</option>
              <option value="false" <%= 'selected' if existing_freespin&.get_advanced_param('user_can_have_duplicates') == false %>>Нет</option>
            </select>
          </div>

          <div class="reward-param-field">
            <label for="freespin_reward_user_can_have_disposable_email_<%= index %>" class="form-label">Одноразовые email</label>
            <select class="form-select" name="<%= field_prefix %>[user_can_have_disposable_email]" id="freespin_reward_user_can_have_disposable_email_<%= index %>">
              <option value="">Не задано</option>
              <option value="true" <%= 'selected' if existing_freespin&.get_advanced_param('user_can_have_disposable_email') == true %>>Разрешить</option>
              <option value="false" <%= 'selected' if existing_freespin&.get_advanced_param('user_can_have_disposable_email') == false %>>Запретить</option>
            </select>
          </div>
          <div class="reward-param-field">
            <label for="freespin_reward_total_deposits_<%= index %>" class="form-label">Общие депозиты</label>
            <input type="number" class="form-control" name="<%= field_prefix %>[total_deposits]"
                   id="freespin_reward_total_deposits_<%= index %>" step="0.01" min="0"
                   value="<%= existing_freespin&.get_advanced_param('total_deposits') %>">
          </div>

          <div class="reward-param-field">
            <label for="freespin_reward_deposits_sum_<%= index %>" class="form-label">Сумма депозитов</label>
            <input type="number" class="form-control" name="<%= field_prefix %>[deposits_sum]"
                   id="freespin_reward_deposits_sum_<%= index %>" step="0.01" min="0"
                   value="<%= existing_freespin&.get_advanced_param('deposits_sum') %>">
          </div>

          <div class="reward-param-field">
            <label for="freespin_reward_loss_sum_<%= index %>" class="form-label">Сумма проигрышей</label>
            <input type="number" class="form-control" name="<%= field_prefix %>[loss_sum]"
                   id="freespin_reward_loss_sum_<%= index %>" step="0.01" min="0"
                   value="<%= existing_freespin&.get_advanced_param('loss_sum') %>">
          </div>

          <div class="reward-param-field">
            <label for="freespin_reward_deposits_count_<%= index %>" class="form-label">Количество депозитов</label>
            <input type="number" class="form-control" name="<%= field_prefix %>[deposits_count]"
                   id="freespin_reward_deposits_count_<%= index %>" min="0"
                   value="<%= existing_freespin&.get_advanced_param('deposits_count') %>">
          </div>

          <div class="reward-param-field">
            <label for="freespin_reward_spend_sum_<%= index %>" class="form-label">Сумма трат</label>
            <input type="number" class="form-control" name="<%= field_prefix %>[spend_sum]"
                   id="freespin_reward_spend_sum_<%= index %>" step="0.01" min="0"
                   value="<%= existing_freespin&.get_advanced_param('spend_sum') %>">
          </div>

          <div class="reward-param-field">
            <label for="freespin_reward_category_loss_sum_<%= index %>" class="form-label">Проигрыши по категории</label>
            <input type="number" class="form-control" name="<%= field_prefix %>[category_loss_sum]"
                   id="freespin_reward_category_loss_sum_<%= index %>" step="0.01" min="0"
                   value="<%= existing_freespin&.get_advanced_param('category_loss_sum') %>">
          </div>

          <div class="reward-param-field">
            <label for="freespin_reward_wager_sum_<%= index %>" class="form-label">Сумма вагера</label>
            <input type="number" class="form-control" name="<%= field_prefix %>[wager_sum]"
                   id="freespin_reward_wager_sum_<%= index %>" step="0.01" min="0"
                   value="<%= existing_freespin&.get_advanced_param('wager_sum') %>">
          </div>

          <div class="reward-param-field">
            <label for="freespin_reward_bets_count_<%= index %>" class="form-label">Количество ставок</label>
            <input type="number" class="form-control" name="<%= field_prefix %>[bets_count]"
                   id="freespin_reward_bets_count_<%= index %>" min="0"
                   value="<%= existing_freespin&.get_advanced_param('bets_count') %>">
          </div>

          <div class="reward-param-field full-width">
            <label for="freespin_reward_affiliates_user_<%= index %>" class="form-label">Пользователь партнера</label>
            <input type="text" class="form-control" name="<%= field_prefix %>[affiliates_user]"
                   id="freespin_reward_affiliates_user_<%= index %>"
                   value="<%= existing_freespin&.get_advanced_param('affiliates_user') %>">
          </div>

          <div class="reward-param-field">
            <label for="freespin_reward_balance_<%= index %>" class="form-label">Баланс</label>
            <input type="number" class="form-control" name="<%= field_prefix %>[balance]"
                   id="freespin_reward_balance_<%= index %>" step="0.01"
                   value="<%= existing_freespin&.get_advanced_param('balance') %>">
          </div>

          <div class="reward-param-field">
            <label for="freespin_reward_stag_<%= index %>" class="form-label">Stag</label>
            <input type="text" class="form-control" name="<%= field_prefix %>[stag]"
                   id="freespin_reward_stag_<%= index %>"
                   value="<%= existing_freespin&.stag %>">
          </div>

          <div class="reward-param-field">
            <label for="freespin_reward_chargeable_comp_points_<%= index %>" class="form-label">Списываемые комп-поинты</label>
            <input type="number" class="form-control" name="<%= field_prefix %>[chargeable_comp_points]"
                   id="freespin_reward_chargeable_comp_points_<%= index %>" step="0.01" min="0"
                   value="<%= existing_freespin&.get_advanced_param('chargeable_comp_points') %>">
          </div>

          <div class="reward-param-field">
            <label for="freespin_reward_persistent_comp_points_<%= index %>" class="form-label">Постоянные комп-поинты</label>
            <input type="number" class="form-control" name="<%= field_prefix %>[persistent_comp_points]"
                   id="freespin_reward_persistent_comp_points_<%= index %>" step="0.01" min="0"
                   value="<%= existing_freespin&.get_advanced_param('persistent_comp_points') %>">
          </div>

          <div class="reward-param-field full-width">
            <label for="freespin_reward_date_of_birth_<%= index %>" class="form-label">Дата рождения</label>
            <input type="date" class="form-control" name="<%= field_prefix %>[date_of_birth]"
                   id="freespin_reward_date_of_birth_<%= index %>"
                   value="<%= existing_freespin&.get_advanced_param('date_of_birth') %>">
          </div>

          <div class="reward-param-field">
            <label for="freespin_reward_deposit_<%= index %>" class="form-label">Депозит</label>
            <input type="number" class="form-control" name="<%= field_prefix %>[deposit]"
                   id="freespin_reward_deposit_<%= index %>" step="0.01" min="0"
                   value="<%= existing_freespin&.get_advanced_param('deposit') %>">
          </div>

          <div class="reward-param-field">
            <label for="freespin_reward_gender_<%= index %>" class="form-label">Пол</label>
            <select class="form-select" name="<%= field_prefix %>[gender]" id="freespin_reward_gender_<%= index %>">
              <option value="">Не задано</option>
              <option value="male" <%= 'selected' if existing_freespin&.get_advanced_param('gender') == 'male' %>>Мужской</option>
              <option value="female" <%= 'selected' if existing_freespin&.get_advanced_param('gender') == 'female' %>>Женский</option>
            </select>
          </div>

          <div class="reward-param-field full-width">
            <label for="freespin_reward_issued_bonus_<%= index %>" class="form-label">Выданный бонус</label>
            <input type="text" class="form-control" name="<%= field_prefix %>[issued_bonus]"
                   id="freespin_reward_issued_bonus_<%= index %>"
                   value="<%= existing_freespin&.get_advanced_param('issued_bonus') %>">
          </div>

          <div class="reward-param-field full-width">
            <label for="freespin_reward_registered_<%= index %>" class="form-label">Зарегистрирован</label>
            <input type="date" class="form-control" name="<%= field_prefix %>[registered]"
                   id="freespin_reward_registered_<%= index %>"
                   value="<%= existing_freespin&.get_advanced_param('registered') %>">
          </div>

          <div class="reward-param-field full-width">
            <label for="freespin_reward_social_networks_<%= index %>" class="form-label">Социальные сети</label>
            <input type="text" class="form-control" name="<%= field_prefix %>[social_networks]"
                   id="freespin_reward_social_networks_<%= index %>"
                   value="<%= existing_freespin&.get_advanced_param('social_networks') %>">
          </div>

          <div class="reward-param-field">
            <label for="freespin_reward_wager_done_<%= index %>" class="form-label">Отыгрыш выполнен</label>
            <select class="form-select" name="<%= field_prefix %>[wager_done]" id="freespin_reward_wager_done_<%= index %>">
              <option value="">Не задано</option>
              <option value="true" <%= 'selected' if existing_freespin&.get_advanced_param('wager_done') == true %>>Да</option>
              <option value="false" <%= 'selected' if existing_freespin&.get_advanced_param('wager_done') == false %>>Нет</option>
            </select>
          </div>

          <div class="reward-param-field">
            <label for="freespin_reward_hold_min_<%= index %>" class="form-label">Hold min</label>
            <input type="number" class="form-control" name="<%= field_prefix %>[hold_min]"
                   id="freespin_reward_hold_min_<%= index %>" step="0.01" min="0"
                   value="<%= existing_freespin&.get_advanced_param('hold_min') %>">
          </div>

          <div class="reward-param-field">
            <label for="freespin_reward_hold_max_<%= index %>" class="form-label">Hold max</label>
            <input type="number" class="form-control" name="<%= field_prefix %>[hold_max]"
                   id="freespin_reward_hold_max_<%= index %>" step="0.01" min="0"
                   value="<%= existing_freespin&.get_advanced_param('hold_max') %>">
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function toggleAdvancedFreespinParams() {
  const advancedSection = document.querySelector('.advanced-params.mt-3');
  const toggleButton = document.getElementById('toggle_freespin_advanced');

  if (advancedSection.style.display === 'none') {
    advancedSection.style.display = 'block';
    toggleButton.innerHTML = '<i class="fas fa-minus"></i> Скрыть дополнительные параметры';
  } else {
    advancedSection.style.display = 'none';
    toggleButton.innerHTML = '<i class="fas fa-plus"></i> Показать дополнительные параметры';
  }
}
</script>
  </div>
</div>
