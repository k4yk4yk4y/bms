<% content_for :title, @bonus.name %>

<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1 class="h2"><%= @bonus.name %></h1>
          <div class="d-flex align-items-center gap-2">
            <span class="badge bg-info text-dark"><%= @bonus.event.humanize %></span>
            <span class="badge <%= status_badge_class(@bonus.status) %>">
              <%= @bonus.status.humanize %>
            </span>
            <code><%= @bonus.code %></code>
          </div>
        </div>
        <div class="btn-group" role="group">
          <% if can?(:update, @bonus) %>
            <%= link_to "Edit", edit_bonus_path(@bonus), class: "btn btn-primary" %>
          <% end %>
          <% if can?(:destroy, @bonus) %>
            <%= link_to "Delete", bonus_path(@bonus), 
                class: "btn btn-danger", data: { "turbo-method": :delete, confirm: "Are you sure?" } %>
          <% end %>
          <%= link_to "Back to List", bonuses_path, class: "btn btn-outline-secondary" %>
        </div>
      </div>

      <div class="row">
        <!-- Basic Information -->
        <div class="col-lg-8">
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0">Basic Information</h5>
            </div>
            <div class="card-body">
              <% if @bonus.description.present? %>
                <div class="mb-3">
                  <h6 class="fw-bold">Description:</h6>
                  <p class="text-muted mb-0"><%= simple_format(@bonus.description) %></p>
                </div>
                <hr>
              <% end %>
              
              <div class="row">
                <div class="col-md-6">
                  <dl class="row">
                    <dt class="col-sm-4">Name:</dt>
                    <dd class="col-sm-8"><%= @bonus.name %></dd>
                    
                    <dt class="col-sm-4">Code:</dt>
                    <dd class="col-sm-8"><code><%= @bonus.code %></code></dd>
                    
                    <dt class="col-sm-4">Type:</dt>
                    <dd class="col-sm-8">
                      <span class="badge bg-info text-dark"><%= @bonus.event.humanize %></span>
                    </dd>
                    
                    <dt class="col-sm-4">Status:</dt>
                    <dd class="col-sm-8">
                      <span class="badge <%= status_badge_class(@bonus.status) %>">
                        <%= @bonus.status.humanize %>
                      </span>
                    </dd>
                  </dl>
                </div>
                <div class="col-md-6">
                  <dl class="row">
                    <dt class="col-sm-4">Country:</dt>
                    <dd class="col-sm-8"><%= @bonus.country || 'All' %></dd>
                    
                    <dt class="col-sm-4">User Group:</dt>
                    <dd class="col-sm-8"><%= @bonus.user_group || 'All' %></dd>
                    
                    <dt class="col-sm-4">Tags:</dt>
                    <dd class="col-sm-8">
                      <% if @bonus.tags_array.any? %>
                        <% @bonus.tags_array.each do |tag| %>
                          <span class="badge bg-secondary me-1"><%= tag %></span>
                        <% end %>
                      <% else %>
                        <span class="text-muted">None</span>
                      <% end %>
                    </dd>
                    
                    <dt class="col-sm-4">Project:</dt>
                    <dd class="col-sm-8">
                      <% if @bonus.project.present? %>
                        <span class="badge bg-primary"><%= @bonus.project %></span>
                      <% else %>
                        <span class="text-muted">Not specified</span>
                      <% end %>
                    </dd>
                    
                    <dt class="col-sm-4">DSL Tag:</dt>
                    <dd class="col-sm-8">
                      <% if @bonus.dsl_tag.present? %>
                        <code><%= @bonus.dsl_tag %></code>
                      <% else %>
                        <span class="text-muted">Not specified</span>
                      <% end %>
                    </dd>
                  </dl>
                </div>
              </div>
            </div>
          </div>

          <!-- Currency Minimum Deposits (для депозитных бонусов) -->
          <% if @bonus.event == 'deposit' && @bonus.has_minimum_deposit_requirements? %>
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="card-title mb-0">
                  <i class="bi bi-currency-exchange"></i> 
                  Минимальные депозиты по валютам
                </h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <% @bonus.currency_minimum_deposits.each do |currency, amount| %>
                    <div class="col-md-3 col-sm-6 mb-2">
                      <dl class="row">
                        <dt class="col-sm-4"><%= currency %>:</dt>
                        <dd class="col-sm-8">
                          <span class="badge bg-primary"><%= amount %></span>
                        </dd>
                      </dl>
                    </div>
                  <% end %>
                </div>
              </div>
            </div>
          <% elsif @bonus.event == 'deposit' %>
            <div class="card mb-4">
              <div class="card-header">
                <h5 class="card-title mb-0">
                  <i class="bi bi-currency-exchange"></i> 
                  Минимальные депозиты по валютам
                </h5>
              </div>
              <div class="card-body">
                <div class="alert alert-info mb-0">
                  <i class="bi bi-info-circle"></i>
                  Минимальные депозиты по валютам не установлены
                </div>
              </div>
            </div>
          <% end %>

          <!-- Wagering Information -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0">Wagering Information</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <% 
                  non_deposit_types = %w[input_coupon manual collection groups_update scheduler]
                  should_show_minimum_deposit = !non_deposit_types.include?(@bonus.event) && @bonus.event != 'deposit' && @bonus.minimum_deposit.present?
                %>
                <% if should_show_minimum_deposit %>
                <div class="col-md-4">
                  <dl class="row">
                    <dt class="col-sm-6">Min Deposit:</dt>
                    <dd class="col-sm-6">
                      <%= number_to_currency(@bonus.minimum_deposit) %>
                    </dd>
                  </dl>
                </div>
                <% end %>
                <div class="col-md-4">
                  <dl class="row">
                    <dt class="col-sm-6">Wager:</dt>
                    <dd class="col-sm-6">
                      <%= number_to_currency(@bonus.wager) if @bonus.wager %>
                    </dd>
                  </dl>
                </div>
                <div class="col-md-4">
                  <dl class="row">
                    <dt class="col-sm-6">Max Winnings:</dt>
                    <dd class="col-sm-6">
                      <%= @bonus.formatted_maximum_winnings %>
                    </dd>
                  </dl>
                </div>
              </div>
              <% if @bonus.wagering_strategy.present? %>
                <dl class="row">
                  <dt class="col-sm-2">Strategy:</dt>
                  <dd class="col-sm-10"><%= @bonus.wagering_strategy %></dd>
                </dl>
              <% end %>
            </div>
          </div>

          <!-- Type-Specific Information -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0"><%= @bonus.event.humanize %> Details</h5>
            </div>
            <div class="card-body">
              <%= render "type_specific_details", bonus: @bonus %>
            </div>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
          <!-- Availability -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0">Availability</h5>
            </div>
            <div class="card-body">
              <dl class="row">
                <dt class="col-sm-5">Start Date:</dt>
                <dd class="col-sm-7"><%= @bonus.availability_start_date.strftime("%Y-%m-%d %H:%M") %></dd>
                
                <dt class="col-sm-5">End Date:</dt>
                <dd class="col-sm-7"><%= @bonus.availability_end_date.strftime("%Y-%m-%d %H:%M") %></dd>
                
                <dt class="col-sm-5">Available Now:</dt>
                <dd class="col-sm-7">
                  <% if @bonus.available_now? %>
                    <span class="badge bg-success">Yes</span>
                  <% else %>
                    <span class="badge bg-danger">No</span>
                  <% end %>
                </dd>
                
                <dt class="col-sm-5">Expired:</dt>
                <dd class="col-sm-7">
                  <% if @bonus.expired? %>
                    <span class="badge bg-danger">Yes</span>
                  <% else %>
                    <span class="badge bg-success">No</span>
                  <% end %>
                </dd>
              </dl>
            </div>
          </div>

          <!-- Metadata -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0">Metadata</h5>
            </div>
            <div class="card-body">
              <dl class="row">
                <dt class="col-sm-5">Created:</dt>
                <dd class="col-sm-7"><%= @bonus.created_at.strftime("%Y-%m-%d %H:%M") %></dd>
                
                <dt class="col-sm-5">Updated:</dt>
                <dd class="col-sm-7"><%= @bonus.updated_at.strftime("%Y-%m-%d %H:%M") %></dd>
                
                <% if @bonus.created_by %>
                  <dt class="col-sm-5">Created By:</dt>
                  <dd class="col-sm-7">User #<%= @bonus.created_by %></dd>
                <% end %>
                
                <% if @bonus.updated_by %>
                  <dt class="col-sm-5">Updated By:</dt>
                  <dd class="col-sm-7">User #<%= @bonus.updated_by %></dd>
                <% end %>
              </dl>
            </div>
          </div>

          <!-- Actions -->
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
              <div class="d-grid gap-2">
                <%= link_to "Preview", preview_bonus_path(@bonus), 
                    class: "btn btn-outline-info", 
                    data: { remote: true, toggle: "modal", target: "#previewModal" } %>
                <% if can?(:duplicate, @bonus) %>
                  <%= button_to "Duplicate", duplicate_bonus_path(@bonus), 
                      method: :post, 
                      class: "btn btn-outline-secondary w-100",
                      data: { confirm: "Are you sure you want to duplicate this bonus? A new draft bonus will be created." } %>
                <% end %>
                <%= link_to "Export JSON", bonus_path(@bonus, format: :json), 
                    class: "btn btn-outline-primary", target: "_blank" %>
              </div>
              
              <% if @bonus.errors.any? %>
                <div class="alert alert-warning mt-3">
                  <h6 class="alert-heading">Validation Warnings:</h6>
                  <ul class="mb-0">
                    <% @bonus.errors.full_messages.each do |message| %>
                      <li><%= message %></li>
                    <% end %>
                  </ul>
                  <small class="text-muted">
                    These warnings may prevent the bonus from being duplicated. Please fix them first.
                  </small>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Bonus Preview</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="previewContent">
        <!-- Preview content will be loaded here -->
      </div>
    </div>
  </div>
</div>
