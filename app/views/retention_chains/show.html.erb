<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0"><%= @retention_chain.display_name %></h1>
    <div class="d-flex gap-2">
      <% if can?(:update, @retention_chain) %>
        <%= link_to "Edit chain", edit_retention_chain_path(@retention_chain), class: "btn btn-outline-primary" %>
      <% end %>
      <%= link_to "Back", retention_chains_path, class: "btn btn-outline-secondary" %>
    </div>
  </div>

  <div class="card mb-4">
    <div class="card-body">
      <dl class="row mb-0">
        <dt class="col-sm-3">Project</dt>
        <dd class="col-sm-9"><%= @retention_chain.project&.name || "—" %></dd>
        <dt class="col-sm-3">Status</dt>
        <dd class="col-sm-9"><%= @retention_chain.status.humanize %></dd>
        <dt class="col-sm-3">Launch date</dt>
        <dd class="col-sm-9"><%= @retention_chain.launch_date&.strftime("%Y-%m-%d %H:%M") || "—" %></dd>
        <dt class="col-sm-3">Emails</dt>
        <dd class="col-sm-9"><%= @retention_chain.retention_emails_count %></dd>
        <dt class="col-sm-3">Created at</dt>
        <dd class="col-sm-9"><%= @retention_chain.created_at.strftime("%Y-%m-%d %H:%M") %></dd>
        <dt class="col-sm-3">Updated at</dt>
        <dd class="col-sm-9"><%= @retention_chain.updated_at.strftime("%Y-%m-%d %H:%M") %></dd>
        <% if can_read_users? %>
          <dt class="col-sm-3">Created by</dt>
          <dd class="col-sm-9"><%= user_profile_link(@retention_chain.creator) || "—" %></dd>
          <dt class="col-sm-3">Updated by</dt>
          <dd class="col-sm-9"><%= user_profile_link(@retention_chain.updater) || "—" %></dd>
        <% end %>
      </dl>
    </div>
  </div>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="h5 mb-0">Emails</h2>
    <% if can?(:create, RetentionEmail) %>
      <%= link_to "New email", new_retention_chain_retention_email_path(@retention_chain), class: "btn btn-sm btn-primary" %>
    <% end %>
  </div>

  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped mb-0">
          <thead class="table-light">
            <tr>
              <th style="width: 32px;"></th>
              <th>Subject</th>
              <th>Header</th>
              <th>Status</th>
              <th>Timing</th>
              <th>Bonuses</th>
              <th>Launch date</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody data-controller="retention-emails-sort"
                 data-retention-emails-sort-url-value="<%= reorder_retention_chain_retention_emails_path(@retention_chain) %>"
                 data-retention-emails-sort-enabled-value="<%= can?(:update, RetentionEmail) %>">
            <% @retention_emails.each do |email| %>
              <tr data-retention-emails-sort-target="item"
                  data-id="<%= email.id %>"
                  draggable="<%= can?(:update, RetentionEmail) %>">
                <td class="text-muted">
                  <% if can?(:update, RetentionEmail) %>
                    <i class="fas fa-grip-vertical"></i>
                  <% end %>
                </td>
                <td><%= link_to email.display_subject, retention_chain_retention_email_path(@retention_chain, email) %></td>
                <td><%= email.header.presence || "—" %></td>
                <td><span class="badge bg-secondary"><%= email.status.humanize %></span></td>
                <td><%= email.send_timing.presence || "—" %></td>
                <td>
                  <% if email.bonuses.any? %>
                    <div class="d-flex flex-wrap gap-2">
                      <% email.bonuses.each do |bonus| %>
                        <% label = bonus.name.presence || "Bonus ##{bonus.id}" %>
                        <% label = bonus.code.present? ? "#{label} (#{bonus.code})" : label %>
                        <%= link_to label, bonus_path(bonus), class: "retention-bonus-link" %>
                      <% end %>
                    </div>
                  <% else %>
                    <span class="text-muted">—</span>
                  <% end %>
                </td>
                <td><%= email.launch_date&.strftime("%Y-%m-%d %H:%M") || "—" %></td>
                <td class="text-end">
                  <div class="btn-group btn-group-sm" role="group">
                    <%= link_to retention_chain_retention_email_path(@retention_chain, email),
                                class: "btn btn-outline-info",
                                title: "View" do %>
                      <i class="fas fa-eye"></i>
                    <% end %>
                    <% if can?(:update, email) %>
                      <%= link_to edit_retention_chain_retention_email_path(@retention_chain, email),
                                  class: "btn btn-outline-primary",
                                  title: "Edit" do %>
                        <i class="fas fa-edit"></i>
                      <% end %>
                    <% end %>
                    <% if can?(:destroy, email) %>
                      <%= button_to retention_chain_retention_email_path(@retention_chain, email),
                                    method: :delete,
                                    data: { confirm: "Delete retention email?" },
                                    class: "btn btn-outline-danger",
                                    title: "Delete" do %>
                        <i class="fas fa-trash"></i>
                      <% end %>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
            <% if @retention_emails.empty? %>
              <tr>
                <td colspan="8" class="text-center text-muted py-4">No emails in this chain.</td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
