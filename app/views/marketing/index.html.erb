<% content_for(:title, "Marketing") %>

<style>
  /* Прямоугольные табы без закругления */
  #marketingTabs .nav-link {
    border-radius: 0 !important;
    border: 1px solid #dee2e6;
    margin-right: -1px;
  }
  
  #marketingTabs .nav-link:first-child {
    border-top-left-radius: 0 !important;
    border-bottom-left-radius: 0 !important;
  }
  
  #marketingTabs .nav-link:last-child {
    border-top-right-radius: 0 !important;
    border-bottom-right-radius: 0 !important;
  }
  
  #marketingTabs .nav-link.active {
    border-color: #0d6efd;
    background-color: #0d6efd;
    color: white;
  }
  
  #marketingTabs .nav-link:not(.active):hover {
    background-color: #f8f9fa;
    border-color: #dee2e6;
  }
</style>

<div class="container-fluid marketing-page">
  <div class="row">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2 mb-0">
          <i class="fas fa-bullhorn text-primary"></i>
          Marketing
        </h1>
        <div class="d-flex gap-2">
          <% if can?(:create, MarketingRequest) %>
            <%= link_to new_marketing_path(request_type: @current_tab), 
                        class: "btn btn-primary" do %>
              <i class="fas fa-plus"></i> Добавить заявку
            <% end %>
          <% end %>
        </div>
      </div>

      <!-- Табы для типов заявок -->
      <ul class="nav nav-tabs mb-4" id="marketingTabs" role="tablist">
        <% @tabs.each_with_index do |tab, index| %>
          <li class="nav-item" role="presentation">
            <%= link_to marketing_index_path(tab: tab[:key], search: params[:search], status: params[:status], page: nil), 
                        class: "nav-link #{'active' if @current_tab == tab[:key]}", 
                        id: "#{tab[:key]}-tab",
                        role: "tab",
                        'aria-controls': tab[:key],
                        'aria-selected': @current_tab == tab[:key] do %>
              <%= tab[:label] %>
              <%= tab_count_badge(tab[:count]) %>
            <% end %>
          </li>
        <% end %>
      </ul>

      <!-- Поиск и фильтры -->
      <div class="row mb-3">
        <div class="col-md-4">
          <%= form_with url: marketing_index_path, method: :get, local: true, class: "d-flex" do |form| %>
            <%= form.hidden_field :tab, value: @current_tab %>
            <%= form.hidden_field :status, value: params[:status] if params[:status].present? %>
            <%= form.hidden_field :page, value: params[:page] if params[:page].present? %>
            <%= form.text_field :search, 
                placeholder: "Поиск по промокоду, STAG, менеджеру или email...", 
                value: params[:search], 
                class: "form-control form-control-sm me-2" %>
            <%= form.submit "Найти", class: "btn btn-outline-primary btn-sm" %>
            <% if params[:search].present? %>
              <%= link_to "Очистить", marketing_index_path(tab: @current_tab, status: params[:status]), 
                          class: "btn btn-outline-secondary btn-sm ms-1" %>
            <% end %>
          <% end %>
        </div>
        <div class="col-md-6">
          <div class="btn-group" role="group" aria-label="Фильтр по статусу">
            <%= link_to "Все", marketing_index_path(tab: @current_tab, search: params[:search], page: nil), 
                        class: "btn btn-outline-secondary #{'active' if params[:status].blank?}" %>
            <%= link_to "Ожидают", marketing_index_path(tab: @current_tab, status: 'pending', search: params[:search], page: nil), 
                        class: "btn btn-outline-warning #{'active' if params[:status] == 'pending'}" %>
            <%= link_to "Активированы", marketing_index_path(tab: @current_tab, status: 'activated', search: params[:search], page: nil), 
                        class: "btn btn-outline-success #{'active' if params[:status] == 'activated'}" %>
            <%= link_to "Отклонены", marketing_index_path(tab: @current_tab, status: 'rejected', search: params[:search], page: nil), 
                        class: "btn btn-outline-danger #{'active' if params[:status] == 'rejected'}" %>
          </div>
        </div>
        <div class="col-md-2 text-end marketing-summary">
          <small class="text-muted">
            <% if params[:search].present? %>
              Найдено: <%= @total_requests %>
              <br><small>по запросу "<%= params[:search] %>"</small>
            <% else %>
              Всего заявок: <%= @total_requests %>
            <% end %>
            <% if @total_pages > 1 %>
              <br><small>Страница <%= @current_page %> из <%= @total_pages %></small>
            <% end %>
          </small>
        </div>
      </div>

      <!-- Таблица заявок -->
      <div class="card">
        <div class="card-body">
          <% if @marketing_requests.any? %>
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead class="table-dark">
                  <tr>
                    <th>Менеджер</th>
                    <% unless current_user.support_agent? || current_user.shift_leader? %>
                      <th>Площадка</th>
                      <th>Почта партнёра</th>
                    <% end %>
                    <th>Промокод</th>
                    <th>STAG</th>
                    <th>Дата активации</th>
                    <th>Статус</th>
                    <% if can?(:update, MarketingRequest) || can?(:destroy, MarketingRequest) %>
                      <th>Действия</th>
                    <% end %>
                  </tr>
                </thead>
                <tbody>
                  <% @marketing_requests.each do |request| %>
                    <tr>
                      <td>
                        <strong><%= request.manager %></strong>
                      </td>
                      <% unless current_user.support_agent? || current_user.shift_leader? %>
                        <td>
                          <% if request.platform.present? %>
                            <% if request.platform.match?(URI::DEFAULT_PARSER.make_regexp) %>
                              <%= link_to request.platform, request.platform, 
                                          target: "_blank", 
                                          class: "text-primary text-decoration-none" %>
                              <i class="fas fa-external-link-alt ms-1"></i>
                            <% else %>
                              <%= truncate(request.platform, length: 50) %>
                            <% end %>
                          <% else %>
                            <span class="text-muted">—</span>
                          <% end %>
                        </td>
                        <td>
                          <%= mail_to request.partner_email, request.partner_email, 
                                      class: "text-decoration-none" %>
                        </td>
                      <% end %>
                      <td>
                        <% codes = request.promo_codes_array %>
                        <% if codes.length == 1 %>
                          <code class="bg-light px-2 py-1 rounded">
                            <%= codes.first %>
                          </code>
                        <% else %>
                          <div class="d-flex flex-wrap gap-1">
                            <% codes.each do |code| %>
                              <code class="bg-light px-1 py-1 rounded small">
                                <%= code %>
                              </code>
                            <% end %>
                          </div>
                          <small class="text-muted">(<%= codes.length %> кодов)</small>
                        <% end %>
                      </td>
                      <td>
                        <code class="bg-light px-2 py-1 rounded">
                          <%= request.stag %>
                        </code>
                        <% if request.has_existing_partner_request? %>
                          <br>
                          <small class="text-warning">
                            <i class="fas fa-exclamation-triangle"></i>
                            Есть другие заявки
                          </small>
                        <% end %>
                      </td>
                      <td>
                        <% if request.activation_date %>
                          <%= l(request.activation_date, format: :short) %>
                        <% else %>
                          <span class="text-muted">—</span>
                        <% end %>
                      </td>
                      <td>
                        <span class="badge 
                                     <%= case request.status
                                         when 'pending' then 'bg-warning'
                                         when 'activated' then 'bg-success'
                                         when 'rejected' then 'bg-danger'
                                         end %>">
                          <%= request.status_label %>
                        </span>
                      </td>
                      <% if can?(:update, MarketingRequest) || can?(:destroy, MarketingRequest) %>
                        <td>
                          <div class="btn-group btn-group-sm" role="group">
                            <%= link_to marketing_path(request), 
                                        class: "btn btn-outline-primary btn-sm",
                                        title: "Просмотр" do %>
                              <i class="fas fa-eye"></i>
                            <% end %>
                            
                            <% if can?(:update, request) %>
                              <%= link_to edit_marketing_path(request), 
                                          class: "btn btn-outline-secondary btn-sm",
                                          title: "Редактировать" do %>
                                <i class="fas fa-edit"></i>
                              <% end %>
                            <% end %>

                            <% if request.pending? %>
                              <% if can?(:activate, request) %>
                                <%= link_to activate_marketing_path(request), 
                                            method: :patch,
                                            class: "btn btn-outline-success btn-sm",
                                            title: "Активировать",
                                            data: { 
                                              confirm: "Активировать заявку?",
                                              turbo_method: :patch 
                                            } do %>
                                  <i class="fas fa-check"></i>
                                <% end %>
                              <% end %>
                              
                              <% if can?(:reject, request) %>
                                <%= link_to reject_marketing_path(request), 
                                            method: :patch,
                                            class: "btn btn-outline-danger btn-sm",
                                            title: "Отклонить",
                                            data: { 
                                              confirm: "Отклонить заявку?",
                                              turbo_method: :patch 
                                            } do %>
                                  <i class="fas fa-times"></i>
                                <% end %>
                              <% end %>
                            <% end %>

                            <% if can?(:destroy, request) %>
                              <%= link_to marketing_path(request), 
                                          method: :delete,
                                          class: "btn btn-outline-danger btn-sm",
                                          title: "Удалить",
                                          data: { 
                                            confirm: "Удалить заявку? Это действие нельзя отменить.",
                                            turbo_method: :delete 
                                          } do %>
                                <i class="fas fa-trash"></i>
                              <% end %>
                            <% end %>
                          </div>
                        </td>
                      <% end %>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
            
            <!-- Pagination -->
            <% if @total_pages > 1 %>
              <div class="d-flex justify-content-between align-items-center mt-3">
                <div>
                  <small class="text-muted">
                    Показано <%= [(@current_page - 1) * 25 + 1, @total_requests].min %> - 
                    <%= [@current_page * 25, @total_requests].min %> из <%= @total_requests %>
                  </small>
                </div>
                <nav aria-label="Page navigation">
                  <ul class="pagination pagination-sm mb-0">
                    <% if @current_page > 1 %>
                      <li class="page-item">
                        <%= link_to "Предыдущая", marketing_index_path(
                          tab: @current_tab, 
                          search: params[:search], 
                          status: params[:status], 
                          page: @current_page - 1
                        ), class: "page-link" %>
                      </li>
                    <% else %>
                      <li class="page-item disabled">
                        <span class="page-link">Предыдущая</span>
                      </li>
                    <% end %>
                    
                    <% start_page = [@current_page - 2, 1].max %>
                    <% end_page = [start_page + 4, @total_pages].min %>
                    <% start_page = [end_page - 4, 1].max if end_page - start_page < 4 %>
                    
                    <% if start_page > 1 %>
                      <li class="page-item">
                        <%= link_to "1", marketing_index_path(
                          tab: @current_tab, 
                          search: params[:search], 
                          status: params[:status], 
                          page: 1
                        ), class: "page-link" %>
                      </li>
                      <% if start_page > 2 %>
                        <li class="page-item disabled">
                          <span class="page-link">...</span>
                        </li>
                      <% end %>
                    <% end %>
                    
                    <% (start_page..end_page).each do |page_num| %>
                      <li class="page-item <%= 'active' if page_num == @current_page %>">
                        <%= link_to page_num, marketing_index_path(
                          tab: @current_tab, 
                          search: params[:search], 
                          status: params[:status], 
                          page: page_num
                        ), class: "page-link" %>
                      </li>
                    <% end %>
                    
                    <% if end_page < @total_pages %>
                      <% if end_page < @total_pages - 1 %>
                        <li class="page-item disabled">
                          <span class="page-link">...</span>
                        </li>
                      <% end %>
                      <li class="page-item">
                        <%= link_to @total_pages, marketing_index_path(
                          tab: @current_tab, 
                          search: params[:search], 
                          status: params[:status], 
                          page: @total_pages
                        ), class: "page-link" %>
                      </li>
                    <% end %>
                    
                    <% if @current_page < @total_pages %>
                      <li class="page-item">
                        <%= link_to "Следующая", marketing_index_path(
                          tab: @current_tab, 
                          search: params[:search], 
                          status: params[:status], 
                          page: @current_page + 1
                        ), class: "page-link" %>
                      </li>
                    <% else %>
                      <li class="page-item disabled">
                        <span class="page-link">Следующая</span>
                      </li>
                    <% end %>
                  </ul>
                </nav>
              </div>
            <% end %>
          <% else %>
            <div class="text-center py-5">
              <i class="fas fa-<%= params[:search].present? ? 'search' : 'inbox' %> fa-3x text-muted mb-3"></i>
              <h5 class="text-muted">
                <%= params[:search].present? ? 'Ничего не найдено' : 'Заявки не найдены' %>
              </h5>
              <p class="text-muted">
                <% if params[:search].present? %>
                  По запросу "<%= params[:search] %>" в типе "<%= MarketingRequest::REQUEST_TYPE_LABELS[@current_tab] %>"
                  <% if params[:status].present? %>
                    со статусом "<%= MarketingRequest::STATUS_LABELS[params[:status]] %>"
                  <% end %>
                  ничего не найдено.
                <% else %>
                  Нет заявок типа "<%= MarketingRequest::REQUEST_TYPE_LABELS[@current_tab] %>"
                  <% if params[:status].present? %>
                    со статусом "<%= MarketingRequest::STATUS_LABELS[params[:status]] %>"
                  <% end %>
                <% end %>
              </p>
              <% if can?(:create, MarketingRequest) %>
                <%= link_to new_marketing_path(request_type: @current_tab), 
                            class: "btn btn-primary" do %>
                  <i class="fas fa-plus"></i> Создать первую заявку
                <% end %>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
